<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Love You in Lightyears</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.128.0/examples/jsm/"
            }
        }
    </script>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Inter', sans-serif; background-color: #000011; color: #fff; }
        .view { width: 100vw; height: 100vh; position: fixed; top: 0; left: 0; display: none; }
        #homepage-view {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%);
            text-align: center;
            padding: 20px;
            overflow-y: auto; 
        }
        #homepage-view h1 { font-size: clamp(2.5em, 8vw, 3.5em); margin-bottom: 20px; color: #E0E7FF; text-shadow: 0 0 15px #C7D2FE, 0 0 25px #A5B4FC; }
        #homepage-view p { font-size: clamp(1em, 4vw, 1.2em); margin-bottom: 30px; color: #A5B4FC; max-width: 600px; }
        #daily-celestial-thought {
            font-size: clamp(0.9em, 3.5vw, 1.1em);
            font-style: italic;
            color: #C7D2FE;
            margin: 20px auto 30px;
            padding: 15px;
            max-width: 500px;
            border: 1px dashed rgba(165, 180, 252, 0.5);
            border-radius: 8px;
            background-color: rgba(255,255,255,0.05);
        }
        #homepage-view .contact-info { font-size: clamp(1em, 3.8vw, 1.1em); margin-bottom: 40px; color: #C7D2FE; }
        #homepage-view .contact-info a { color: #87CEFA; text-decoration: underline; }
        #enter-solar-system-btn {
            padding: 12px 25px; 
            font-size: clamp(1.1em, 4.5vw, 1.3em);
            background-color: #4A90E2; color: white; border: none;
            border-radius: 8px; cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            box-shadow: 0 5px 15px rgba(74, 144, 226, 0.4);
        }
        #enter-solar-system-btn:hover { background-color: #357ABD; transform: translateY(-2px); }
        #homepage-credit {
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 0.75em;
            color: rgba(200, 200, 255, 0.6);
        }
        #admin-login-section { margin-top: 30px; padding:15px; background-color:rgba(0,0,30,0.5); border-radius:8px; }
        #admin-login-section input { color: #333; margin: 5px; padding: 8px; border-radius: 4px; border: 1px solid #ccc;}
        #admin-login-section button { background-color: #673AB7; color:white; padding: 8px 15px; border-radius:4px; }


        #solarsystem-view { }
        #canvas-container { width: 100%; height: 100%; position: absolute; cursor: grab; }
        #canvas-container:active { cursor: grabbing; }


        #search-bar-container {
            position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
            z-index: 20; display: flex; flex-wrap: wrap;
            gap: 8px; padding: 8px;
            background-color: rgba(0, 0, 20, 0.7); border-radius: 8px; backdrop-filter: blur(5px);
            width: 95%; max-width: 400px;
        }
        #search-bar-container input {
            padding: 8px 12px; border-radius: 6px;
            border: 1px solid rgba(100, 100, 200, 0.3);
            background-color: rgba(255, 255, 255, 0.1); color: #fff;
            flex-grow: 1; 
            min-width: 150px;
        }
        #search-bar-container button {
            padding: 8px 15px; background-color: #4A90E2; color: white;
            border: none; border-radius: 6px; cursor: pointer;
        }
        #search-bar-container button:hover { background-color: #357ABD; }

        #info-panel {
            position: fixed; top: 10px; right: -95%; 
            width: 90%; max-width: 350px; 
            background-color: rgba(0, 0, 20, 0.85); backdrop-filter: blur(10px);
            border: 1px solid rgba(100, 100, 200, 0.5); border-radius: 12px;
            padding: 15px; box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            transition: right 0.5s ease-in-out; z-index: 10;
            max-height: calc(100vh - 20px); overflow-y: auto;
        }
        #info-panel.visible { right: 10px; } 
        @media (min-width: 640px) { 
            #info-panel { top: 20px; right: -400px; width: 350px; padding: 20px; }
            #info-panel.visible { right: 20px; }
            #search-bar-container { width: auto; max-width: none; flex-wrap: nowrap; }
        }

        #info-panel h3 { text-align: center; margin-bottom: 15px; font-size: 1.4em;}
        #info-panel h4 { font-size: 1.1em; color: #87CEFA; margin-top:10px; margin-bottom:5px; }
        #info-panel label { display: block; margin-top: 10px; font-size: 0.9em; color: #aaa; }
        #info-panel input, #info-panel textarea, #info-panel select {
            width: 100%; padding: 8px; margin-top: 5px; border-radius: 6px;
            background-color: rgba(255, 255, 255, 0.1); border: 1px solid rgba(100, 100, 200, 0.3); color: #fff;
        }
        #info-panel select option { background-color: #000011; color: #fff; }
        #info-panel input[type="color"] { padding: 0; height: 40px; }
        #info-panel button {
            background-color: #4A90E2; color: white; padding: 10px 15px; border: none;
            border-radius: 6px; cursor: pointer; margin-top: 15px; transition: background-color 0.3s;
        }
        #info-panel button:hover { background-color: #357ABD; }
        
        #save-star-btn { width: calc(50% - 5px); }
        #close-panel-btn { background-color: #E94E77; width: calc(50% - 5px); }
        #close-panel-btn:hover { background-color: #D33A60; }

        .gemini-feature-btn {
            background-color: #673AB7; display: block; width: 100%; margin-top: 10px;
        }
        .gemini-feature-btn:hover { background-color: #512DA8; }
        .loading-gemini { font-size: 0.8em; color: #aaa; margin-left: 10px; display: inline-block;}

        .star-image-input-group { margin-bottom: 5px; }
        .star-image-preview-container img, #view-star-photo-container img {
            max-width: 100%; height: auto; max-height: 100px; object-fit: cover;
            margin-top: 5px; border-radius: 4px; border: 1px solid rgba(100,100,200,0.2);
            display: block; 
        }
        #view-star-photo-container { display: flex; flex-direction: column; gap: 5px; margin-top: 10px;}


        #planet-summary-display { font-size: 0.95em; line-height: 1.5; color: #ddd; margin-top: 5px; }
        #gemini-planet-response-area { margin-top:15px; padding:10px; background-color: rgba(255,255,255,0.05); border-radius:6px; font-size:0.9em; line-height:1.4; max-height: 200px; overflow-y: auto;}
        .button-container { display: flex; justify-content: space-between; margin-top: 20px; }

        #user-info { position: fixed; bottom: 10px; left: 10px; background-color: rgba(0,0,0,0.5); padding: 8px 12px; border-radius: 6px; font-size: 0.9em; z-index: 5; }
        #admin-controls { position: fixed; bottom: 10px; right: 10px; z-index: 25; }
        #admin-controls button { font-size: 0.8em; padding: 5px 10px; background-color: #777; color:white; border-radius:4px; }

        #message-box { position: fixed; bottom: 10px; right: 10px; background-color: rgba(74, 144, 226, 0.9); color: white; padding: 10px 15px; border-radius: 6px; z-index: 100; opacity: 0; transition: opacity 0.5s; font-size: 0.9em; }
        #message-box.visible { opacity: 1; }
        #loading-indicator { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 200; color: white; font-size: 1.5em; }
    
    </style>
</head>
<body>
    <div id="homepage-view" class="view" style="display: flex;">
        <h1>Love You in Lightyears</h1>
        <p>Explore a galaxy of named stars, each a unique tribute. Discover celestial memorials and the stories they hold.</p>
        <div id="daily-celestial-thought">Loading a thought from the cosmos...</div>
        <div class="contact-info">
            Want to name a star after you or a loved one? <br/>
            Contact me: <a href="#" id="contact-link-placeholder">[Your IG/WhatsApp/Email Here]</a>
        </div>
        <button id="enter-solar-system-btn">Enter Solar System</button>
        <div id="admin-login-section">
            <input type="email" id="admin-email" placeholder="Admin Email">
            <input type="password" id="admin-password" placeholder="Admin Password">
            <button id="admin-login-btn">Admin Login</button>
        </div>
        <div id="homepage-credit">Designed by Josh and Gemini AI</div>
    </div>

    <div id="solarsystem-view" class="view">
        <div id="canvas-container"></div>
        <div id="search-bar-container">
            <input type="text" id="coord-search-input" placeholder="X,Y,Z, Star ID or Planet">
            <button id="coord-search-btn">Search</button>
        </div>
        <div id="info-panel">
            <h3 id="panel-title">Object Details</h3>
            <div id="object-id-display-container" style="display:block;">
                <strong>ID:</strong> <span id="object-id-display">N/A</span>
            </div>
            <div id="object-coords-display-container" style="display:block;">
                 <strong>Coords:</strong> <span id="object-coords-display">N/A</span>
            </div>

            <div id="star-edit-fields" style="display:none;">
                <h4>Edit Star</h4>
                <label for="star-name">Name:</label>
                <input type="text" id="star-name" placeholder="Enter star name">
                <label for="star-category">Category:</label>
                <select id="star-category">
                    <option value="general">General Memorial</option>
                    <option value="pet">Pet Memorial</option>
                    <option value="couple">Couple Tribute</option>
                    <option value="milestone">Personal Milestone</option>
                    <option value="other">Other</option>
                </select>
                <label for="star-color">Color:</label>
                <input type="color" id="star-color" value="#FFFFFF">
                
                <label>Photo URLs (up to 5):</label>
                <div id="star-image-inputs-container">
                    <div class="star-image-input-group"><input type="text" id="star-photo-url-1" placeholder="Image URL 1"></div>
                    <div class="star-image-input-group"><input type="text" id="star-photo-url-2" placeholder="Image URL 2 (optional)"></div>
                    <div class="star-image-input-group"><input type="text" id="star-photo-url-3" placeholder="Image URL 3 (optional)"></div>
                    <div class="star-image-input-group"><input type="text" id="star-photo-url-4" placeholder="Image URL 4 (optional)"></div>
                    <div class="star-image-input-group"><input type="text" id="star-photo-url-5" placeholder="Image URL 5 (optional)"></div>
                </div>
                <div id="star-image-preview-container" class="star-image-preview-container"></div>


                <label for="star-description">Description:</label>
                <textarea id="star-description" rows="3" placeholder="A short message or description..."></textarea>
                <button id="weave-star-story-btn" class="gemini-feature-btn">✨ Weave Star Story</button>
                <span id="weave-story-loading" class="loading-gemini" style="display:none;">Weaving...</span>
            </div>

            <div id="star-view-fields" style="display:none;">
                <h4>Star Information</h4>
                <div><strong>Name:</strong> <span id="view-star-name"></span></div>
                <div><strong>Category:</strong> <span id="view-star-category"></span></div>
                <div id="view-star-photo-container"></div>
                <p id="view-star-description" style="margin-top:10px;"></p>
            </div>

            <div id="planet-info-fields" style="display:none;">
                <h4>Planet Information</h4>
                <div><strong>Name:</strong> <span id="planet-name-display"></span></div>
                <p id="planet-summary-display"></p>
                <hr class="my-3 border-gray-600">
                <h5>✨ Ask Gemini About <span id="gemini-planet-name"></span></h5>
                <input type="text" id="gemini-planet-question" placeholder="Ask a question..." class="mt-1">
                <button id="ask-gemini-planet-btn" class="gemini-feature-btn">Ask Gemini</button>
                <span id="ask-planet-loading" class="loading-gemini" style="display:none;">Asking...</span>
                <div id="gemini-planet-response-area" style="display:none;"></div>
            </div>
            
            <div class="button-container">
                <button id="save-star-btn" style="display:none;">Save Changes</button>
                <button id="close-panel-btn">Close</button>
            </div>
        </div>
        <div id="user-info">User ID: <span id="user-id-display"></span> (<span id="user-mode-display">User</span>)</div>
        <div id="admin-controls" style="display:none;">
             <button id="admin-logout-btn">Admin Logout</button>
        </div>
    </div>

    <div id="loading-indicator" style="display:none;">Loading Solar System...</div>
    <div id="message-box"></div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            // signInWithCustomToken, // Not used
            onAuthStateChanged, 
            setPersistence, 
            browserLocalPersistence,
            signInWithEmailAndPassword,
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', async () => {
            const firebaseConfigFromUser = {
                apiKey: "AIzaSyDxNAcZ_q9R-TDOkmYOratPzYK-sK5PCB4", // Sensitive data, manage securely
                authDomain: "love-you-in-lightyears.firebaseapp.com",
                projectId: "love-you-in-lightyears",
                storageBucket: "love-you-in-lightyears.appspot.com", 
                messagingSenderId: "682979494336",
                appId: "1:682979494336:web:340c2f2ad0662d5dc0a025",
                measurementId: "G-PNHZTR1HL0"
            };
            
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfigFromUser;
            const appIdPath = typeof __app_id !== 'undefined' ? __app_id : 'love-you-lightyears-prod'; 
            
            // !!! IMPORTANT: Replace this with your actual Admin User ID from Firebase Authentication !!!
            // This UID is for the user you created with Email/Password in Firebase Auth for admin access.
            const ADMIN_UID = "qdoYG8voQWhCCMPWipwlGxXsa6A2"; 

            let app, auth, db;
            let userId = null;
            let isAuthReady = false;
            let isAdmin = false;
            let isSceneReady = false; // New flag to track if Three.js scene is initialized

            // --- DOM Element Variables ---
            const homepageView = document.getElementById('homepage-view');
            const dailyCelestialThoughtEl = document.getElementById('daily-celestial-thought');
            const solarsystemView = document.getElementById('solarsystem-view');
            const enterSolarSystemBtn = document.getElementById('enter-solar-system-btn');
            const adminLoginSection = document.getElementById('admin-login-section');
            const adminEmailInput = document.getElementById('admin-email');
            const adminPasswordInput = document.getElementById('admin-password');
            const adminLoginBtn = document.getElementById('admin-login-btn');
            const adminControls = document.getElementById('admin-controls');
            const adminLogoutBtn = document.getElementById('admin-logout-btn');
            const searchBarContainer = document.getElementById('search-bar-container'); // Get search bar

            const loadingIndicator = document.getElementById('loading-indicator');
            const canvasContainer = document.getElementById('canvas-container');
            const infoPanel = document.getElementById('info-panel');
            const panelTitle = document.getElementById('panel-title');
            const objectIdDisplayContainer = document.getElementById('object-id-display-container');
            const objectIdDisplay = document.getElementById('object-id-display');
            const objectCoordsDisplayContainer = document.getElementById('object-coords-display-container');
            const objectCoordsDisplay = document.getElementById('object-coords-display');
            
            const starEditFields = document.getElementById('star-edit-fields');
            const starNameInput = document.getElementById('star-name');
            const starCategorySelect = document.getElementById('star-category');
            const starColorInput = document.getElementById('star-color');
            // const starImageInputsContainer = document.getElementById('star-image-inputs-container'); // Already got
            const starImagePreviewContainer = document.getElementById('star-image-preview-container');
            const starPhotoUrlInputs = [ 
                document.getElementById('star-photo-url-1'),
                document.getElementById('star-photo-url-2'),
                document.getElementById('star-photo-url-3'),
                document.getElementById('star-photo-url-4'),
                document.getElementById('star-photo-url-5')
            ];
            const starDescriptionInput = document.getElementById('star-description');
            const weaveStarStoryBtn = document.getElementById('weave-star-story-btn');
            const weaveStoryLoading = document.getElementById('weave-story-loading');

            const starViewFields = document.getElementById('star-view-fields');
            const viewStarName = document.getElementById('view-star-name');
            const viewStarCategory = document.getElementById('view-star-category');
            const viewStarPhotoContainer = document.getElementById('view-star-photo-container');
            const viewStarDescription = document.getElementById('view-star-description');
            
            const planetInfoFields = document.getElementById('planet-info-fields');
            const planetNameDisplay = document.getElementById('planet-name-display');
            const planetSummaryDisplay = document.getElementById('planet-summary-display');
            const geminiPlanetName = document.getElementById('gemini-planet-name');
            const geminiPlanetQuestion = document.getElementById('gemini-planet-question');
            const askGeminiPlanetBtn = document.getElementById('ask-gemini-planet-btn');
            const askPlanetLoading = document.getElementById('ask-planet-loading');
            const geminiPlanetResponseArea = document.getElementById('gemini-planet-response-area');
                    
            const saveStarBtn = document.getElementById('save-star-btn');
            const closePanelBtn = document.getElementById('close-panel-btn');
            const userIdDisplay = document.getElementById('user-id-display');
            const userModeDisplay = document.getElementById('user-mode-display');
            const messageBox = document.getElementById('message-box');
            const coordSearchInput = document.getElementById('coord-search-input');
            const coordSearchBtn = document.getElementById('coord-search-btn');

            // --- Three.js Variables ---
            let scene, camera, renderer, controls;
            let sun; // earth, saturnRings are set in initThreeJS if needed locally
            const planets = []; 
            const moons = [];
            const stars = []; 
            const PROCEDURAL_STAR_COUNT = 2500; 
            const SPECIAL_STAR_COUNT = 50; 
            let selectedObject = null;
            const raycaster = new THREE.Raycaster();
            const mouse = new THREE.Vector2();
            const initialStarPositions = []; 
            const specialStarInitialPositions = [];
            // const textureLoader = new THREE.TextureLoader(); // Defined locally if needed or use one instance
            let shootingStarSystem;
            const SHOOTING_STAR_COUNT = 20;
            
            // --- Data & Constants ---
            const planetSummaries = {
                "Mercury": "The smallest planet in our solar system and closest to the Sun, Mercury is a world of extreme temperatures. It has a heavily cratered surface, resembling Earth's Moon.",
                "Venus": "Venus is Earth's closest planetary neighbor. Similar in structure and size to Earth, Venus spins slowly in the opposite direction of most planets. Its thick atmosphere traps heat in a runaway greenhouse effect, making it the hottest planet in our solar system.",
                "Earth": "Our home planet, Earth is the only place we know of so far that’s inhabited by living things. It's also the only planet in our solar system with liquid water on the surface.",
                "Mars": "Mars is a dusty, cold, desert world with a very thin atmosphere. There is strong evidence Mars was billions of years ago wetter and warmer, with a thicker atmosphere.",
                "Jupiter": "Jupiter is more than twice as massive than the other planets of our solar system combined. The giant planet's Great Red Spot is a centuries-old storm bigger than Earth.",
                "Saturn": "Adorned with thousands of beautiful ringlets, Saturn is unique among the planets. It is not the only planet to have rings, but none are as spectacular or as complex as Saturn's.",
                "Uranus": "Uranus is the seventh planet from the Sun and has the third-largest diameter in our solar system. It was the first planet found with the aid of a telescope, Uranus is an ice giant.",
                "Neptune": "Dark, cold, and whipped by supersonic winds, ice giant Neptune is the eighth and most distant planet in our solar system. More than 30 times as far from the Sun as Earth, Neptune is the only planet in our solar system not visible to the naked eye."
            };
            
            // --- Initialization ---
            await initializeFirebase(); 
            fetchDailyCelestialThought(); // Fetch thought after DOM is ready

            // --- Event Listeners Setup ---
            enterSolarSystemBtn.addEventListener('click', () => {
                homepageView.style.display = 'none';
                solarsystemView.style.display = 'block';
                loadingIndicator.style.display = 'flex';
                if (!scene) { 
                    initThreeJS(); // Creates scene, stars, planets. Calls loadAllStarData() at its end.
                    animate();
                } else {
                    loadingIndicator.style.display = 'none'; 
                }
            });

            adminLoginBtn.addEventListener('click', async () => {
                const email = adminEmailInput.value;
                const password = adminPasswordInput.value;
                if (!email || !password) {
                    showMessage("Please enter admin email and password.", true);
                    return;
                }
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    // onAuthStateChanged will handle setting isAdmin and UI updates (hiding form, showing controls)
                    showMessage("Admin login successful!");
                    // adminLoginSection.style.display = 'none'; // Let onAuthStateChanged handle this
                } catch (error) {
                    console.error("Admin Login Error:", error);
                    showMessage(`Admin Login Failed: ${error.message}`, true);
                }
            });

            adminLogoutBtn.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    // onAuthStateChanged will handle UI updates (signing in anonymously, showing login form)
                    showMessage("Admin logged out.");
                } catch (error) {
                    console.error("Admin Logout Error:", error);
                    showMessage(`Admin Logout Failed: ${error.message}`, true);
                }
            });
            
            // --- Firebase Initialization ---
            async function initializeFirebase() { 
                try {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    // setLogLevel('debug'); // Enable for detailed Firestore logs if needed, but can be verbose
                    await setPersistence(auth, browserLocalPersistence); 

                    return new Promise((resolve) => {
                        onAuthStateChanged(auth, async (currentUser) => {
                            if (currentUser) {
                                userId = currentUser.uid;
                                if (!currentUser.isAnonymous && currentUser.uid === ADMIN_UID) {
                                    isAdmin = true;
                                    console.log("Admin signed in:", userId);
                                    adminLoginSection.style.display = 'none';
                                    adminControls.style.display = 'block';
                                } else if (!currentUser.isAnonymous && currentUser.uid !== ADMIN_UID) {
                                    isAdmin = false;
                                    console.log("Non-admin authenticated user signed in:", userId);
                                    adminLoginSection.style.display = 'none'; // Hide admin login form
                                    adminControls.style.display = 'none';
                                } else { // Anonymous user
                                    isAdmin = false;
                                    userId = currentUser.uid; // Ensure userId is set for anonymous user
                                    console.log("Anonymous user signed in:", userId);
                                    adminLoginSection.style.display = 'block';
                                    adminControls.style.display = 'none';
                                }
                            } else { // No user logged in (e.g., after signOut before anonymous sign-in completes)
                                isAdmin = false;
                                userId = null;
                                console.log("No user. Attempting anonymous sign-in.");
                                adminControls.style.display = 'none';
                                adminLoginSection.style.display = 'block'; // Show login while attempting anonymous
                                try {
                                    const { user: anonUser } = await signInAnonymously(auth);
                                    // onAuthStateChanged will fire again with this anonymous user.
                                    // userId will be set in that subsequent call.
                                    console.log("Signed in anonymously (callback will follow):", anonUser.uid);
                                } catch (anonError) {
                                    console.error("Anonymous Sign-In Error:", anonError);
                                    userId = 'anonymous_error_' + crypto.randomUUID();
                                    adminLoginSection.style.display = 'block'; 
                                }
                            }

                            userIdDisplay.textContent = userId || 'Initializing...';
                            userModeDisplay.textContent = isAdmin ? "Admin" : "User";
                            
                            if (!isAuthReady) { // Resolve the promise only on the first valid auth state
                                isAuthReady = true;
                                resolve(); 
                            }
                            checkAndLoadStarData(); 
                        });
                    });
                } catch (error) { 
                    console.error("Firebase initialization error:", error);
                    showMessage("Error connecting to services. Some features may not work.", true);
                    userId = 'error_user_' + crypto.randomUUID();
                    userIdDisplay.textContent = userId;
                    isAuthReady = true; 
                    return Promise.resolve(); // Resolve even on error to not block other page loads
                }
            }

            function checkAndLoadStarData() {
                if (isAuthReady && isSceneReady && userId && !userId.startsWith('anonymous_error_')) {
                    console.log("Auth and Scene are ready, loading star data.");
                    loadAllStarData();
                } else {
                    // console.log("Skipping loadAllStarData. AuthReady:", isAuthReady, "SceneReady:", isSceneReady, "UserID:", userId);
                }
            }

            // --- Texture Creation ---
            function createTexture(color, detailColor = null, width = 256, height = 256) {
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const context = canvas.getContext('2d');
                context.fillStyle = color;
                context.fillRect(0, 0, width, height);
                if (detailColor) {
                    for (let i = 0; i < 50 * (width/256); i++) { 
                        context.fillStyle = `rgba(${Math.random()*255}, ${Math.random()*255}, ${Math.random()*255}, ${0.3 + Math.random()*0.4})`;
                        context.beginPath();
                        context.arc(Math.random() * width, Math.random() * height, Math.random() * (width/8), 0, Math.PI * 2);
                        context.fill();
                    }
                }
                return new THREE.CanvasTexture(canvas);
            }
             function createAtmosphereTexture() { 
                const canvas = document.createElement('canvas');
                canvas.width = 128;
                canvas.height = 128;
                const context = canvas.getContext('2d');
                const gradient = context.createRadialGradient(64, 64, 0, 64, 64, 64);
                gradient.addColorStop(0.2, 'rgba(173, 216, 230, 0.8)'); 
                gradient.addColorStop(0.5, 'rgba(70, 130, 180, 0.5)');  
                gradient.addColorStop(1, 'rgba(0, 0, 139, 0)');      
                context.fillStyle = gradient;
                context.fillRect(0, 0, 128, 128);
                return new THREE.CanvasTexture(canvas);
            }

            // --- Three.js Scene Initialization ---
            function initThreeJS() {
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0x000011);
                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 20000);
                camera.position.set(0, 350, 900);
                renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(window.devicePixelRatio);
                canvasContainer.innerHTML = ''; // Clear previous canvas if any (e.g., on error/re-init)
                canvasContainer.appendChild(renderer.domElement);
                controls = new OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.minDistance = 10; 
                controls.maxDistance = 10000;
                const ambientLight = new THREE.AmbientLight(0xcccccc, 1.0); // Slightly brighter ambient
                scene.add(ambientLight);

                const sunBaseColor = '#D95F02'; 
                const sunDetailColor = '#A33B00'; 
                const sunEmissiveColor = 0xBF4800; 
                const sunTexture = createTexture(sunBaseColor, sunDetailColor, 512, 512);
                const sunMaterial = new THREE.MeshBasicMaterial({ map: sunTexture, emissive: sunEmissiveColor, emissiveIntensity: 1.3 });
                sun = new THREE.Mesh(new THREE.SphereGeometry(70, 64, 64), sunMaterial);
                sun.userData = { name: "Sun", id: "sun", isPlanet: true, summary: "The star at the center of our Solar System. It provides the light and heat that make life on Earth possible." };
                scene.add(sun);
                const sunLight = new THREE.PointLight(0xFFDAB9, 3.5, 15000); 
                sun.add(sunLight);

                const planetData = [ 
                    { name: "Mercury", size: 3, color: '#888888', orbitRadius: 120, orbitSpeed: 0.012, moons: [] },
                    { name: "Venus", size: 7, color: '#E6E6FA', orbitRadius: 180, orbitSpeed: 0.009, moons: [] },
                    { name: "Earth", size: 7.5, color: '#4A90E2', orbitRadius: 250, orbitSpeed: 0.007, moons: [
                        { name: "Moon", size: 2, color: '#AAAAAA', orbitRadius: 15, orbitSpeed: 0.05 }
                    ]},
                    { name: "Mars", size: 4.5, color: '#E57373', orbitRadius: 330, orbitSpeed: 0.005, moons: [
                        { name: "Phobos", size: 0.5, color: '#555555', orbitRadius: 8, orbitSpeed: 0.1 }, 
                        { name: "Deimos", size: 0.4, color: '#666666', orbitRadius: 12, orbitSpeed: 0.08 }
                    ]},
                    { name: "Jupiter", size: 30, color: '#D2B48C', orbitRadius: 550, orbitSpeed: 0.002, moons: [
                        { name: "Io", size: 2.5, color: '#FFFF00', orbitRadius: 40, orbitSpeed: 0.06 },
                        { name: "Europa", size: 2.2, color: '#FFF8DC', orbitRadius: 50, orbitSpeed: 0.05 },
                        { name: "Ganymede", size: 3.5, color: '#A9A9A9', orbitRadius: 65, orbitSpeed: 0.04 },
                        { name: "Callisto", size: 3.3, color: '#808080', orbitRadius: 80, orbitSpeed: 0.03 }
                    ]},
                    { name: "Saturn", size: 25, color: '#D4A373', orbitRadius: 750, orbitSpeed: 0.0015, hasRings: true, ringColor: '#BCB091', moons: [
                         { name: "Titan", size: 3.8, color: '#FFA500', orbitRadius: 45, orbitSpeed: 0.035 }
                    ]},
                    { name: "Uranus", size: 15, color: '#AFEEEE', orbitRadius: 950, orbitSpeed: 0.001, moons: [] },
                    { name: "Neptune", size: 14, color: '#3B5998', orbitRadius: 1150, orbitSpeed: 0.0008, moons: [] }
                ];

                let earthRef = null; // Reference to Earth for atmosphere

                planetData.forEach(pData => {
                    const planetMaterial = new THREE.MeshStandardMaterial({ color: new THREE.Color(pData.color), roughness: 0.8, metalness: 0.1 });
                    const planet = new THREE.Mesh(new THREE.SphereGeometry(pData.size, 32, 32), planetMaterial);
                    planet.position.x = pData.orbitRadius;
                    planet.userData = { 
                        name: pData.name, 
                        id: pData.name.toLowerCase(),
                        orbitRadius: pData.orbitRadius, 
                        orbitSpeed: pData.orbitSpeed, 
                        orbitAngle: Math.random() * Math.PI * 2, 
                        isPlanet: true,
                        summary: planetSummaries[pData.name] || "No summary available."
                    };
                    sun.add(planet); // Add planet as child of Sun for orbital mechanics
                    planets.push(planet);
                    if (pData.name === "Earth") earthRef = planet;

                    if (pData.hasRings) {
                        const ringMaterial = new THREE.MeshStandardMaterial({ color: new THREE.Color(pData.ringColor), side: THREE.DoubleSide, transparent: true, opacity: 0.6, roughness: 0.9 });
                        const saturnRings = new THREE.Mesh(new THREE.RingGeometry(pData.size * 1.2, pData.size * 2.2, 64), ringMaterial);
                        saturnRings.rotation.x = Math.PI / 2.2;
                        planet.add(saturnRings); // Add rings to Saturn
                    }
                    pData.moons.forEach(mData => {
                        const moonMaterial = new THREE.MeshStandardMaterial({ color: new THREE.Color(mData.color), roughness: 0.9 });
                        const moon = new THREE.Mesh(new THREE.SphereGeometry(mData.size, 16, 16), moonMaterial);
                        moon.position.x = mData.orbitRadius;
                        moon.userData = { 
                            name: mData.name, 
                            id: mData.name.toLowerCase(), 
                            orbitRadius: mData.orbitRadius, 
                            orbitSpeed: mData.orbitSpeed, 
                            orbitAngle: Math.random() * Math.PI * 2, 
                            isMoon: true, 
                            parentPlanet: planet // Link back to parent planet
                        };
                        planet.add(moon); // Add moon as child of its planet
                        moons.push(moon);
                    });
                });

                if (earthRef) { 
                    const atmosphereMaterial = new THREE.SpriteMaterial({
                        map: createAtmosphereTexture(), color: 0x4A90E2, transparent: true, opacity: 0.3, blending: THREE.AdditiveBlending
                    });
                    const atmosphere = new THREE.Sprite(atmosphereMaterial);
                    const earthSize = planetData.find(p=>p.name==="Earth").size;
                    atmosphere.scale.set(earthSize * 2.5, earthSize * 2.5, earthSize * 2.5);
                    earthRef.add(atmosphere);
                }

                createStars();
                createShootingStars();

                // Event listeners specific to Three.js view
                window.addEventListener('resize', onWindowResize, false);
                canvasContainer.addEventListener('click', onCanvasClick, false);
                // Other listeners moved to DOMContentLoaded for earlier setup
                
                isSceneReady = true; // Signal that scene is ready
                checkAndLoadStarData(); // Attempt to load star data now that scene is ready

                loadingIndicator.style.display = 'none'; // Hide loading indicator
            }
            
            function pseudoRandom(seed) {
                let state = seed;
                return function() {
                    state = (1103515245 * state + 12345) % 2147483647;
                    return state / 2147483647;
                }
            }

            function createStars() {
                const starMaterial = new THREE.MeshBasicMaterial({ color: 0xFFFFFF });
                const baseStarGeometry = new THREE.SphereGeometry(1, 8, 8); 
                if (initialStarPositions.length === 0) {
                    const prng = pseudoRandom(12345); 
                    for (let i = 0; i < PROCEDURAL_STAR_COUNT; i++) {
                        const x = (prng() - 0.5) * 15000; 
                        const y = (prng() - 0.5) * 15000;
                        const z = (prng() - 0.5) * 15000;
                        const distSq = x*x + y*y + z*z;
                        if (distSq < 500*500) { 
                             initialStarPositions.push({ x: x + Math.sign(x || 1) * 500 , y: y  + Math.sign(y || 1) * 500, z: z + Math.sign(z || 1) * 500 });
                        } else {
                             initialStarPositions.push({ x, y, z });
                        }
                    }
                }
                initialStarPositions.forEach((pos, i) => {
                    const star = new THREE.Mesh(baseStarGeometry.clone(), starMaterial.clone());
                    star.position.set(pos.x, pos.y, pos.z);
                    star.userData = { id: `star_${i}`, originalColor: star.material.color.getHex(), isStar: true, originalPosition: new THREE.Vector3(pos.x, pos.y, pos.z) };
                    stars.push(star);
                    scene.add(star);
                });

                if (specialStarInitialPositions.length === 0) {
                    const prngSpecial = pseudoRandom(54321);
                    for (let i = 0; i < SPECIAL_STAR_COUNT; i++) {
                        const R_MIN = 200; const R_MAX = 2000;
                        let x, y, z, distSq;
                        do { 
                            x = (prngSpecial() - 0.5) * (R_MAX * 2.5); 
                            y = (prngSpecial() - 0.5) * (R_MAX * 1.5);
                            z = (prngSpecial() - 0.5) * (R_MAX * 2.5);
                            distSq = x*x + y*y + z*z;
                        } while (distSq < R_MIN*R_MIN || distSq > R_MAX*R_MAX);
                        specialStarInitialPositions.push({ x, y, z });
                    }
                }
                specialStarInitialPositions.forEach((pos, i) => {
                    const specialStarGeometry = new THREE.SphereGeometry(2.5, 12, 12); 
                    const specialStarMaterial = new THREE.MeshBasicMaterial({ color: 0xFFFF33 }); 
                    const star = new THREE.Mesh(specialStarGeometry, specialStarMaterial.clone());
                    star.position.set(pos.x, pos.y, pos.z);
                    star.userData = { id: `special_star_${i}`, originalColor: star.material.color.getHex(), isStar: true, originalPosition: new THREE.Vector3(pos.x, pos.y, pos.z) }; 
                    stars.push(star); 
                    scene.add(star);
                });
            }
            
            function createShootingStars() {
                const geometry = new THREE.BufferGeometry();
                const material = new THREE.PointsMaterial({
                    color: 0xffffee, size: 3, transparent: true, opacity: 0.8, blending: THREE.AdditiveBlending, sizeAttenuation: true
                });
                const shootingStarVertices = []; 
                for (let i = 0; i < SHOOTING_STAR_COUNT; i++) {
                    shootingStarVertices.push(
                        (Math.random() - 0.5) * 10000, (Math.random() - 0.5) * 10000, (Math.random() - 0.5) * 10000
                    );
                }
                geometry.setAttribute('position', new THREE.Float32BufferAttribute(shootingStarVertices, 3));
                shootingStarSystem = new THREE.Points(geometry, material);
                shootingStarSystem.userData.velocities = [];
                shootingStarSystem.userData.lifespans = []; // Initialize lifespans array
                for (let i = 0; i < SHOOTING_STAR_COUNT; i++) {
                    resetShootingStar(i);
                }
                scene.add(shootingStarSystem);
            }

            function resetShootingStar(index) {
                const R = 4000; 
                const phi = Math.random() * Math.PI * 2;
                const theta = Math.random() * Math.PI;
                const x = R * Math.sin(theta) * Math.cos(phi);
                const y = R * Math.sin(theta) * Math.sin(phi);
                const z = R * Math.cos(theta);
                shootingStarSystem.geometry.attributes.position.setXYZ(index, x, y, z);
                const speed = 50 + Math.random() * 50;
                shootingStarSystem.userData.velocities[index] = new THREE.Vector3(
                    -x + (Math.random() - 0.5) * R*0.2, -y + (Math.random() - 0.5) * R*0.2, -z + (Math.random() - 0.5) * R*0.2
                ).normalize().multiplyScalar(speed);
                shootingStarSystem.userData.lifespans[index] = 50 + Math.random() * 100; // Reset lifespan
            }

            function updateShootingStars() {
                if (!shootingStarSystem) return;
                const positions = shootingStarSystem.geometry.attributes.position;
                for (let i = 0; i < SHOOTING_STAR_COUNT; i++) {
                    positions.setXYZ(
                        i,
                        positions.getX(i) + shootingStarSystem.userData.velocities[i].x,
                        positions.getY(i) + shootingStarSystem.userData.velocities[i].y,
                        positions.getZ(i) + shootingStarSystem.userData.velocities[i].z
                    );
                    shootingStarSystem.userData.lifespans[i]--;
                    if (shootingStarSystem.userData.lifespans[i] <= 0) {
                        resetShootingStar(i);
                    }
                }
                positions.needsUpdate = true;
            }

            // --- Data Handling & Firestore ---
            async function loadAllStarData() {
                if (!db || !isAuthReady || !userId || stars.length === 0) { 
                    // console.log("loadAllStarData: Skipping, prerequisites not met (db, auth, userId, or stars array empty).");
                    return; 
                }
                console.log("Loading all star data from Firestore...");
                for (const star of stars) { 
                    if (!star.userData.isStar) continue;
                    const starId = star.userData.id;
                    // Note: Using appIdPath which was derived from __app_id or default
                    const starDocRef = doc(db, "artifacts", appIdPath, "public", "data", "stars", starId);
                    try {
                        const docSnap = await getDoc(starDocRef);
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            star.userData.name = data.name;
                            star.material.color.set(data.color || star.userData.originalColor);
                            star.userData.photoUrls = data.photoUrls || []; 
                            star.userData.description = data.description;
                            star.userData.category = data.category || "general"; 
                        } else {
                            // Set defaults if not in DB
                            star.userData.name = star.userData.id.startsWith("special") ? "Special Star" : "Unnamed Star";
                            star.material.color.set(star.userData.originalColor);
                            star.userData.photoUrls = [];
                            star.userData.description = "";
                            star.userData.category = "general"; 
                        }
                    } catch (error) {
                        console.error(`Error loading data for star ${starId}: ${error.message}`, error); 
                        showMessage(`Error loading star ${starId}. See console.`, true);
                        // Set error state defaults
                        star.userData.name = star.userData.id.startsWith("special") ? "Special Star (Error)" : "Unnamed Star (Error)";
                        star.material.color.set(star.userData.originalColor);
                    }
                }
                console.log("Star data loading complete.");
            }

            function onWindowResize() {
                if (camera && renderer) {
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(window.innerWidth, window.innerHeight);
                }
            }

            function onCanvasClick(event) {
                // Prevent clicks on UI elements from triggering raycasting
                if (infoPanel.contains(event.target) || searchBarContainer.contains(event.target)) {
                    return; 
                }

                mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
                mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
                raycaster.setFromCamera(mouse, camera);

                // Raycast against stars, planets, and Sun (moons are children and will be caught if 'recursive' is true)
                const allClickableObjects = [...stars, ...planets, sun];
                const intersects = raycaster.intersectObjects(allClickableObjects, true); // true for recursive

                if (intersects.length > 0) {
                    let intersectedMesh = intersects[0].object;
                    
                    // Determine the primary object to select (e.g., planet if a moon is clicked)
                    if (intersectedMesh.userData && intersectedMesh.userData.isMoon) {
                        if (intersectedMesh.userData.parentPlanet) {
                            selectedObject = intersectedMesh.userData.parentPlanet; // Select the parent planet
                        } else {
                            // This case should ideally not happen if moons are set up correctly
                            console.warn("Clicked moon has no parentPlanet link:", intersectedMesh.userData.name);
                            selectedObject = intersectedMesh; // Fallback to selecting the moon itself
                        }
                    } else {
                        selectedObject = intersectedMesh; // Star, planet, or Sun
                    }
                    
                    if (!selectedObject) return; // Safety check

                    const worldPosition = new THREE.Vector3();
                    selectedObject.getWorldPosition(worldPosition);
                    objectCoordsDisplay.textContent = `X: ${worldPosition.x.toFixed(2)}, Y: ${worldPosition.y.toFixed(2)}, Z: ${worldPosition.z.toFixed(2)}`;

                    // Reset panel sections
                    starEditFields.style.display = 'none';
                    starViewFields.style.display = 'none';
                    planetInfoFields.style.display = 'none';
                    saveStarBtn.style.display = 'none';

                    if (selectedObject.userData.isStar) {
                        panelTitle.textContent = "Star Details";
                        objectIdDisplay.textContent = selectedObject.userData.id;
                        if (isAdmin) {
                            starEditFields.style.display = 'block';
                            saveStarBtn.style.display = 'inline-block';
                            populateInfoPanelForStarEdit(selectedObject);
                        } else {
                            starViewFields.style.display = 'block';
                            populateInfoPanelForStarView(selectedObject);
                        }
                    } else if (selectedObject.userData.isPlanet || selectedObject === sun) { // Also handles moons that resolved to parent planets
                        const objectName = selectedObject.userData.name; // Sun also has userData.name
                        panelTitle.textContent = `${objectName} Information`;
                        objectIdDisplay.textContent = selectedObject.userData.id; // Sun also has userData.id
                        planetInfoFields.style.display = 'block';
                        populateInfoPanelForPlanet(selectedObject);
                    } else if (selectedObject.userData.isMoon) {
                        // If we decided to show moon-specific info and had a panel for it
                        panelTitle.textContent = `${selectedObject.userData.name} (Moon) Information`;
                        objectIdDisplay.textContent = selectedObject.userData.id;
                        // Potentially show a simpler panel or message for moons
                        // For now, this path is less likely if moons default to parent planet selection
                        console.log("Selected a moon directly:", selectedObject.userData.name);
                         populateInfoPanelForPlanet(selectedObject); // Or a dedicated moon panel
                    }
                    infoPanel.classList.add('visible');
                }
            }
            
            // --- Gemini API ---
            async function callGeminiAPI(promptText) {
                // CRITICAL SECURITY WARNING: Exposing API keys on the client-side is highly insecure.
                // This key can be stolen and used by others, potentially incurring costs on your account.
                // For production, use a backend (e.g., Firebase Cloud Function) to make API calls.
                const geminiApiKey = "AIzaSyCRu8Re2CX9QBbYBcjLtjJzyhDCzRD8a0k"; // <<< REPLACE AND SECURE THIS KEY!

                if (!geminiApiKey && !(typeof __firebase_config !== 'undefined')) { 
                    const msg = "Gemini API key is missing or not configured for a secure backend call. Features using Gemini will not work without it.";
                    console.error(msg);
                    showMessage(msg, true);
                    return null;
                }
                // If you migrate to a backend, this URL will change to your function's endpoint.
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;
                
                const payload = {
                    contents: [{ role: "user", parts: [{ text: promptText }] }]
                    // Add safetySettings if needed:
                    // "safetySettings": [
                    //   { "category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE" },
                    //   { "category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE" },
                    //   { "category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE" },
                    //   { "category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE" }
                    // ]
                };
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error("Gemini API Error Response:", errorData); // Log the full error
                        let errorMessage = `Gemini API request failed with status ${response.status}`;
                        if (errorData && errorData.error && errorData.error.message) {
                            errorMessage += `: ${errorData.error.message}`;
                        }
                        throw new Error(errorMessage);
                    }
                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                         // Check for blocked responses due to safety settings
                        if (result.candidates && result.candidates.length > 0 && result.candidates[0].finishReason === "SAFETY") {
                            console.warn("Gemini response blocked due to safety settings:", result.candidates[0].safetyRatings);
                            throw new Error("Content generation blocked by safety filters. Try a different prompt.");
                        }
                        console.error("Unexpected Gemini API response structure:", result);
                        throw new Error("Could not extract text from Gemini response.");
                    }
                } catch (error) {
                    console.error("Error calling Gemini API:", error);
                    showMessage(`Error communicating with Gemini: ${error.message}`, true);
                    return null;
                }
            }

            async function fetchDailyCelestialThought() {
                const prompt = "Generate a short (1-2 sentences), inspiring or reflective celestial thought about stars, the cosmos, or our place in the universe. Make it hopeful and wondrous.";
                try {
                    const thought = await callGeminiAPI(prompt);
                    if (thought) {
                        dailyCelestialThoughtEl.textContent = thought;
                    } else {
                        dailyCelestialThoughtEl.textContent = "Look up at the stars and wonder..."; 
                    }
                } catch (e) {
                     dailyCelestialThoughtEl.textContent = "Could not fetch a celestial thought at this time.";
                }
            }

            async function handleWeaveStarStory() {
                if (!selectedObject || !selectedObject.userData.isStar) return;
                const currentStarName = starNameInput.value || "this star";
                const currentDescription = starDescriptionInput.value;
                const category = starCategorySelect.value;
                let categoryContext = "";
                switch(category) {
                    case "pet": categoryContext = "This star is a memorial for a beloved pet."; break;
                    case "couple": categoryContext = "This star is a tribute to a couple's love."; break;
                    case "milestone": categoryContext = "This star commemorates a significant personal milestone."; break;
                    default: categoryContext = "This star is a general memorial or tribute."; break; 
                }
                const prompt = `Write a short, poetic, and hopeful tribute for a celestial star named "${currentStarName}". ${categoryContext} This star is dedicated to a cherished memory. If there's an existing idea for the tribute like: "${currentDescription}", weave that in or expand upon it beautifully. If no idea is provided, create a tribute fitting the context. Keep it under 70 words.`;
                weaveStoryLoading.style.display = 'inline';
                weaveStarStoryBtn.disabled = true;
                try {
                    const story = await callGeminiAPI(prompt);
                    if (story) {
                        starDescriptionInput.value = story;
                        showMessage("✨ Star story woven by Gemini!");
                    } else {
                        showMessage("Could not weave star story at this time (empty response).", true);
                    }
                } catch (e) {
                     showMessage("Could not weave star story: " + e.message, true);
                } finally {
                    weaveStoryLoading.style.display = 'none';
                    weaveStarStoryBtn.disabled = false;
                }
            }

            async function handleAskGeminiAboutPlanet() {
                if (!selectedObject || (!selectedObject.userData.isPlanet && selectedObject !== sun && !selectedObject.userData.isMoon) ) return;
                const objectName = selectedObject.userData.name; // Sun, Planets, Moons all have userData.name
                const question = geminiPlanetQuestion.value.trim();
                if (!question) {
                    showMessage("Please type a question about " + objectName, true);
                    return;
                }
                const prompt = `Regarding the celestial body "${objectName}", please answer the following question concisely and factually: "${question}"`;
                askPlanetLoading.style.display = 'inline';
                askGeminiPlanetBtn.disabled = true;
                geminiPlanetResponseArea.style.display = 'none'; 
                try {
                    const answer = await callGeminiAPI(prompt);
                    if (answer) {
                        geminiPlanetResponseArea.textContent = answer;
                        geminiPlanetResponseArea.style.display = 'block';
                        showMessage(`✨ Gemini answered your question about ${objectName}!`);
                    } else {
                        geminiPlanetResponseArea.textContent = "Sorry, I couldn't get an answer from Gemini at this time (empty response).";
                        geminiPlanetResponseArea.style.display = 'block';
                    }
                } catch (e) {
                    geminiPlanetResponseArea.textContent = "Sorry, I couldn't get an answer: " + e.message;
                    geminiPlanetResponseArea.style.display = 'block';
                } finally {
                    askPlanetLoading.style.display = 'none';
                    askGeminiPlanetBtn.disabled = false;
                }
            }
            
            // --- UI Panel Population & Updates ---
            function updateAllStarImagePreviews() {
                starImagePreviewContainer.innerHTML = ''; // Clear existing previews
                starPhotoUrlInputs.forEach(input => {
                    const url = input.value.trim();
                    if (url) {
                        const img = document.createElement('img');
                        img.src = url;
                        img.alt = "Star photo preview";
                        img.onerror = () => { 
                            // img.style.display = 'none'; // Option 1: Hide broken image links
                            img.alt = "Invalid image URL"; // Option 2: Show alt text
                            // Option 3: Show a placeholder for broken link
                            // img.src = "https://placehold.co/100x50/FF0000/FFFFFF?text=Invalid+URL";
                        };
                        starImagePreviewContainer.appendChild(img);
                    }
                });
            }
            
            function populateInfoPanelForStarEdit(star) { 
                const starDocRef = doc(db, "artifacts", appIdPath, "public", "data", "stars", star.userData.id);
                getDoc(starDocRef).then(docSnap => {
                    let data = {}; 
                    if (docSnap.exists()) { 
                        data = docSnap.data(); 
                    } else { // Defaults if star not yet in DB (e.g. newly created procedural star)
                        data.name = star.userData.name || (star.userData.id.startsWith("special") ? "Special Star" : "Unnamed Star");
                        data.category = star.userData.category || "general";
                        data.color = `#${new THREE.Color(star.userData.originalColor || 0xFFFFFF).getHexString()}`;
                        data.photoUrls = star.userData.photoUrls || [];
                        data.description = star.userData.description || "";
                    }

                    starNameInput.value = data.name;
                    starCategorySelect.value = data.category; 
                    starColorInput.value = data.color;
                    
                    const photoUrls = data.photoUrls || [];
                    starPhotoUrlInputs.forEach((input, i) => {
                        input.value = photoUrls[i] || "";
                    });
                    updateAllStarImagePreviews(); 

                    starDescriptionInput.value = data.description;
                }).catch(error => { 
                    console.error(`Error fetching star details for panel (ID: ${star.userData.id}): ${error.message}`, error); 
                    showMessage(`Could not load star details for ${star.userData.id}. Using local data. Error: ${error.message}`, true);
                    // Fallback to existing userData if Firestore fetch fails
                    starNameInput.value = star.userData.name || (star.userData.id.startsWith("special") ? "Special Star" : "Unnamed Star");
                    starCategorySelect.value = star.userData.category || "general";
                    starColorInput.value = star.userData.color ? star.userData.color : `#${new THREE.Color(star.userData.originalColor || 0xFFFFFF).getHexString()}`;
                    const photoUrls = star.userData.photoUrls || [];
                     starPhotoUrlInputs.forEach((input, i) => {
                        input.value = photoUrls[i] || "";
                    });
                    updateAllStarImagePreviews();
                    starDescriptionInput.value = star.userData.description || "";
                });
            }

            function populateInfoPanelForStarView(star) { 
                const starDocRef = doc(db, "artifacts", appIdPath, "public", "data", "stars", star.userData.id);
                getDoc(starDocRef).then(docSnap => {
                    let data = {}; 
                    if (docSnap.exists()) { 
                        data = docSnap.data(); 
                    }  else { // Defaults if star not yet in DB
                        data.name = star.userData.name || (star.userData.id.startsWith("special") ? "Special Star" : "Unnamed Star");
                        data.category = star.userData.category || "general";
                        data.photoUrls = star.userData.photoUrls || [];
                        data.description = star.userData.description || "No description available.";
                    }

                    viewStarName.textContent = data.name;
                    const category = data.category;
                    let categoryText = category.charAt(0).toUpperCase() + category.slice(1);
                    if (category === "pet") categoryText = "Pet Memorial";
                    else if (category === "couple") categoryText = "Couple Tribute";
                    else if (category === "milestone") categoryText = "Personal Milestone";
                    else if (category === "general") categoryText = "General Memorial";
                    viewStarCategory.textContent = categoryText;

                    viewStarPhotoContainer.innerHTML = ''; 
                    const photoUrls = Array.isArray(data.photoUrls) ? data.photoUrls.filter(url => url && url.trim()) : [];

                    if (photoUrls.length > 0) {
                        photoUrls.forEach(url => {
                            const img = document.createElement('img');
                            img.src = url;
                            img.alt = "Star photo";
                            img.onerror = () => { img.style.display = 'none'; };
                            viewStarPhotoContainer.appendChild(img);
                        });
                    } else {
                         const img = document.createElement('img');
                         img.src = "https://placehold.co/300x200/000022/FFFFFF?text=No+Image"; // Placeholder
                         img.alt = "No image available";
                         viewStarPhotoContainer.appendChild(img);
                    }
                    
                    viewStarDescription.textContent = data.description || "No description available.";
                }).catch(error => {
                    console.error(`Error fetching star details for view (ID: ${star.userData.id}): ${error.message}`, error); 
                    showMessage(`Could not load star details for ${star.userData.id}. Error: ${error.message}`, true);
                    viewStarName.textContent = (star.userData.name || (star.userData.id.startsWith("special") ? "Special Star" : "Unnamed Star")) + " (Error)";
                    viewStarCategory.textContent = "N/A";
                    viewStarPhotoContainer.innerHTML = '<p>Error loading images.</p>';
                    viewStarDescription.textContent = "Could not load details.";
                });
            }

            function populateInfoPanelForPlanet(planetOrMoon) {
                // Handles Sun, Planets, and Moons (if selected directly)
                const objectName = planetOrMoon.userData.name;
                let summary = planetOrMoon.userData.summary; // Planets and Sun have this

                if (planetOrMoon.userData.isMoon) {
                    summary = `A moon orbiting ${planetOrMoon.userData.parentPlanet.userData.name}. ${summary || 'No specific summary for this moon.'}`;
                     panelTitle.textContent = `${objectName} (Moon) Information`;
                } else { // Sun or Planet
                     panelTitle.textContent = `${objectName} Information`;
                }
                
                planetNameDisplay.textContent = objectName;
                planetSummaryDisplay.textContent = summary || "Details for this celestial body are being gathered.";
                geminiPlanetName.textContent = objectName; 
                geminiPlanetQuestion.value = ""; 
                geminiPlanetResponseArea.style.display = 'none'; 
                geminiPlanetResponseArea.textContent = "";
            }


            async function saveSelectedStarData() {
                if (!isAdmin || !selectedObject || !selectedObject.userData.isStar || !db || !isAuthReady || !userId) {
                    showMessage("Cannot save: Not admin, no star selected, or services not ready.", true);
                    return;
                }
                const star = selectedObject; 
                const starId = star.userData.id;
                const photoUrlsToSave = starPhotoUrlInputs.map(input => input.value.trim()).filter(url => url); 

                const dataToSave = {
                    name: starNameInput.value.trim() || (starId.startsWith("special") ? "Special Star" : "Unnamed Star"),
                    category: starCategorySelect.value, 
                    color: starColorInput.value, 
                    photoUrls: photoUrlsToSave, 
                    description: starDescriptionInput.value.trim() || "",
                    updatedAt: serverTimestamp(),
                    updatedBy: userId
                };
                const starDocRef = doc(db, "artifacts", appIdPath, "public", "data", "stars", starId);
                try {
                    const docSnap = await getDoc(starDocRef);
                    if (!docSnap.exists()) { // If it's a new star being saved for the first time
                        const worldPosition = new THREE.Vector3();
                        star.getWorldPosition(worldPosition); // Get its current (potentially original) position
                        dataToSave.originalPosition = { x: worldPosition.x, y: worldPosition.y, z: worldPosition.z };
                        dataToSave.createdAt = serverTimestamp();
                        dataToSave.createdBy = userId; // Track who created it
                    }
                    await setDoc(starDocRef, dataToSave, { merge: true }); 
                    
                    // Update local star object's userData and appearance
                    star.userData.name = dataToSave.name;
                    star.userData.category = dataToSave.category; 
                    if (star.material && star.material.color) { // Ensure material exists
                        star.material.color.set(dataToSave.color);
                    }
                    star.userData.photoUrls = dataToSave.photoUrls;
                    star.userData.description = dataToSave.description;

                    showMessage(`Star '${dataToSave.name}' saved successfully!`);
                    infoPanel.classList.remove('visible');
                } catch (error) {
                    console.error("Error saving star data:", error);
                    showMessage("Failed to save star data. Please try again.", true);
                }
            }
            
            function searchStarByUserInput() {
                const input = coordSearchInput.value.trim();
                if (!input) {
                    showMessage("Please enter coordinates, Star ID, or Planet/Moon Name.", true);
                    return;
                }

                let foundTarget = null;
                let targetType = null; // "star", "planet", "moon"

                // 1. Try searching by Star ID
                foundTarget = stars.find(s => s.userData.id.toLowerCase() === input.toLowerCase());
                if (foundTarget) targetType = "star";

                // 2. If not found by Star ID, try searching by Planet or Sun Name
                if (!foundTarget) {
                    if (sun.userData.name.toLowerCase() === input.toLowerCase()) {
                        foundTarget = sun;
                        targetType = "planet"; // Sun is treated like a planet for info panel
                    } else {
                        foundTarget = planets.find(p => p.userData.name.toLowerCase() === input.toLowerCase());
                        if (foundTarget) targetType = "planet";
                    }
                }

                // 3. If not found yet, try searching by Moon Name
                if (!foundTarget) {
                    foundTarget = moons.find(m => m.userData.name.toLowerCase() === input.toLowerCase());
                    if (foundTarget) {
                        // If a moon is found by name, we might want to select its parent planet for focus,
                        // or the moon itself if we have moon-specific views.
                        // For simplicity in camera focusing, let's focus on the moon itself.
                        // The onCanvasClick logic will handle if parent planet info should be shown.
                        targetType = "moon"; 
                    }
                }
                
                // 4. If not found by ID or Name, try parsing coordinates (for stars mainly)
                if (!foundTarget) {
                    const parts = input.split(',').map(part => parseFloat(part.trim()));
                    if (parts.length === 3 && !parts.some(isNaN)) {
                        const searchPos = new THREE.Vector3(parts[0], parts[1], parts[2]);
                        let closestStar = null;
                        let minDistanceSq = Infinity;
                        stars.forEach(star => {
                            const starPos = new THREE.Vector3();
                            star.getWorldPosition(starPos); // Ensure using world position
                            const distanceSq = starPos.distanceToSquared(searchPos);
                            if (distanceSq < minDistanceSq) {
                                minDistanceSq = distanceSq;
                                closestStar = star;
                            }
                        });
                        // Add a threshold for "closest" to avoid selecting very distant stars
                        if (closestStar && minDistanceSq < (500*500) ) { // Example threshold: within 500 units
                            foundTarget = closestStar;
                            targetType = "star";
                        }
                    }
                }

                if (foundTarget) {
                    // Determine the object to be displayed in the panel (might be parent planet for moons)
                    if (targetType === "moon" && foundTarget.userData.parentPlanet) {
                        selectedObject = foundTarget.userData.parentPlanet; // Panel shows parent planet
                    } else {
                        selectedObject = foundTarget; // Panel shows the found star/planet/sun
                    }
                    
                    const focusTargetPosition = new THREE.Vector3();
                    foundTarget.getWorldPosition(focusTargetPosition); // Camera focuses on the actual found mesh (star, planet, moon)
                    
                    controls.target.copy(focusTargetPosition); 

                    let offsetDistance;
                    const targetRadius = foundTarget.geometry.parameters.radius || 1;
                    if (targetType === "star") {
                        offsetDistance = targetRadius * 15 + 70; 
                    } else { // planet or moon
                        offsetDistance = targetRadius * 5 + 100; 
                    }

                    let direction = new THREE.Vector3().subVectors(camera.position, focusTargetPosition);
                    if (direction.lengthSq() < 0.0001) { 
                        direction.set(0, 0.5, 1); // Default direction if camera is at target
                    }
                    direction.normalize();
                    
                    const newCameraPosition = new THREE.Vector3().addVectors(focusTargetPosition, direction.multiplyScalar(offsetDistance));
                    camera.position.copy(newCameraPosition);
                    controls.update(); // Important to apply changes

                    // Reset panel sections before populating
                    starEditFields.style.display = 'none';
                    starViewFields.style.display = 'none';
                    planetInfoFields.style.display = 'none';
                    saveStarBtn.style.display = 'none';
                    objectIdDisplayContainer.style.display = 'block'; 
                    objectCoordsDisplayContainer.style.display = 'block';
                    
                    const displayObjWorldPos = new THREE.Vector3();
                    selectedObject.getWorldPosition(displayObjWorldPos); // Coords of the object whose info is displayed
                    objectCoordsDisplay.textContent = `X: ${displayObjWorldPos.x.toFixed(2)}, Y: ${displayObjWorldPos.y.toFixed(2)}, Z: ${displayObjWorldPos.z.toFixed(2)}`;


                    if (selectedObject.userData.isStar) {
                        panelTitle.textContent = "Star Details";
                        objectIdDisplay.textContent = selectedObject.userData.id;
                        if (isAdmin) {
                            starEditFields.style.display = 'block';
                            saveStarBtn.style.display = 'inline-block';
                            populateInfoPanelForStarEdit(selectedObject);
                        } else {
                            starViewFields.style.display = 'block';
                            populateInfoPanelForStarView(selectedObject);
                        }
                    } else if (selectedObject.userData.isPlanet || selectedObject === sun) { // Covers planets, sun, and moons that resolved to parent planets
                        const objectName = selectedObject.userData.name;
                        panelTitle.textContent = `${objectName} Information`;
                        objectIdDisplay.textContent = selectedObject.userData.id;
                        planetInfoFields.style.display = 'block';
                        populateInfoPanelForPlanet(selectedObject);
                    }
                    // No specific 'else if (targetType === "moon")' needed here for panel logic
                    // as 'selectedObject' is already set to parent planet or the moon itself handled by populateInfoPanelForPlanet
                    
                    infoPanel.classList.add('visible');
                    showMessage(`Focusing on: ${foundTarget.userData.name || foundTarget.userData.id}`);
                } else {
                    showMessage("Object not found with the given ID, name, or coordinates.", true);
                }
            }

            function showMessage(message, isError = false) {
                messageBox.textContent = message;
                messageBox.style.backgroundColor = isError ? 'rgba(200, 50, 50, 0.9)' : 'rgba(74, 144, 226, 0.9)';
                messageBox.classList.add('visible');
                setTimeout(() => { messageBox.classList.remove('visible'); }, 3000);
            }
            
            // --- Animation Loop ---
            function animate() {
                requestAnimationFrame(animate);
                if (controls) controls.update(); // Update orbit controls

                const time = Date.now() * 0.0001; // Use a time factor for consistent speed

                planets.forEach(planet => {
                    // planet.userData.orbitAngle += planet.userData.orbitSpeed; // Original
                    planet.userData.orbitAngle = time * (planet.userData.orbitSpeed * 100) + (planet.userData.initialOrbitAngle || 0); // Time-based
                    planet.position.x = Math.cos(planet.userData.orbitAngle) * planet.userData.orbitRadius;
                    planet.position.z = Math.sin(planet.userData.orbitAngle) * planet.userData.orbitRadius;
                    planet.rotation.y += 0.002; // Self-rotation
                });
                moons.forEach(moon => {
                    // moon.userData.orbitAngle += moon.userData.orbitSpeed; // Original
                    moon.userData.orbitAngle = time * (moon.userData.orbitSpeed * 100) + (moon.userData.initialOrbitAngle || 0); // Time-based
                    moon.position.x = Math.cos(moon.userData.orbitAngle) * moon.userData.orbitRadius;
                    moon.position.z = Math.sin(moon.userData.orbitAngle) * moon.userData.orbitRadius;
                    moon.rotation.y += 0.005; // Self-rotation
                });

                updateShootingStars();
                if (renderer && scene && camera) renderer.render(scene, camera);
            }

            // --- Setup event listeners that are not dependent on Three.js init here ---
            saveStarBtn.addEventListener('click', saveSelectedStarData);
            closePanelBtn.addEventListener('click', () => infoPanel.classList.remove('visible'));
            
            starPhotoUrlInputs.forEach(input => {
                input.addEventListener('input', updateAllStarImagePreviews);
            });

            coordSearchBtn.addEventListener('click', searchStarByUserInput);
            weaveStarStoryBtn.addEventListener('click', handleWeaveStarStory);
            askGeminiPlanetBtn.addEventListener('click', handleAskGeminiAboutPlanet);

        }); // End of DOMContentLoaded listener
    </script>
</body>
</html>
