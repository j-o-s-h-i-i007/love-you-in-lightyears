<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Love You in Lightyears</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.128.0/examples/jsm/"
            }
        }
    </script>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Inter', sans-serif; background-color: #000011; color: #fff; -webkit-tap-highlight-color: transparent; }
        .view { width: 100vw; height: 100vh; position: fixed; top: 0; left: 0; display: none; }
        #homepage-view {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%);
            text-align: center;
            padding: 20px;
            overflow-y: auto; 
        }
        #homepage-view h1 { font-size: clamp(2.5em, 8vw, 3.5em); margin-bottom: 20px; color: #E0E7FF; text-shadow: 0 0 15px #C7D2FE, 0 0 25px #A5B4FC; }
        #homepage-view p { font-size: clamp(1em, 4vw, 1.2em); margin-bottom: 30px; color: #A5B4FC; max-width: 600px; }
        /* Removed #daily-celestial-thought style */
        #homepage-view .contact-info { font-size: clamp(1em, 3.8vw, 1.1em); margin-bottom: 40px; color: #C7D2FE; }
        #homepage-view .contact-info a { color: #87CEFA; text-decoration: underline; }
        #enter-solar-system-btn {
            padding: 12px 25px; 
            font-size: clamp(1.1em, 4.5vw, 1.3em);
            background-color: #4A90E2; color: white; border: none;
            border-radius: 8px; cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            box-shadow: 0 5px 15px rgba(74, 144, 226, 0.4);
        }
        #enter-solar-system-btn:hover { background-color: #357ABD; transform: translateY(-2px); }
        #homepage-credit {
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 0.75em;
            color: rgba(200, 200, 255, 0.6);
        }
        /* Removed #admin-login-section styles */

        #solarsystem-view { }
        #canvas-container { width: 100%; height: 100%; position: absolute; cursor: grab; touch-action: none; }
        #canvas-container:active { cursor: grabbing; }

        #back-to-homepage-btn {
            position: fixed; 
            top: 10px; 
            left: 10px; 
            z-index: 30; 
            padding: 8px 12px; 
            background-color: rgba(96, 125, 139, 0.8);
            backdrop-filter: blur(5px);
            color: white; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer;
            font-size: 0.9em;
        }
         #back-to-homepage-btn:hover { background-color: rgba(76, 105, 119, 0.9); }

        #search-bar-container {
            position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
            z-index: 20; display: flex; flex-wrap: wrap;
            gap: 8px; padding: 8px;
            background-color: rgba(0, 0, 20, 0.7); border-radius: 8px; backdrop-filter: blur(5px);
            width: 95%; max-width: 400px;
        }
        #search-bar-container input {
            padding: 8px 12px; border-radius: 6px;
            border: 1px solid rgba(100, 100, 200, 0.3);
            background-color: rgba(255, 255, 255, 0.1); color: #fff;
            flex-grow: 1; 
            min-width: 150px;
        }
        #search-bar-container button {
            padding: 8px 15px; background-color: #4A90E2; color: white;
            border: none; border-radius: 6px; cursor: pointer;
        }
        #search-bar-container button:hover { background-color: #357ABD; }

        #info-panel {
            position: fixed; top: 10px; right: -95%; 
            width: 90%; max-width: 350px; 
            background-color: rgba(0, 0, 20, 0.85); backdrop-filter: blur(10px);
            border: 1px solid rgba(100, 100, 200, 0.5); border-radius: 12px;
            padding: 15px; box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            transition: right 0.5s ease-in-out; z-index: 10;
            max-height: calc(100vh - 20px); overflow-y: auto;
        }
        #info-panel.visible { right: 10px; } 
        @media (min-width: 640px) { 
            #info-panel { top: 20px; right: -400px; width: 350px; padding: 20px; }
            #info-panel.visible { right: 20px; }
            #search-bar-container { width: auto; max-width: none; flex-wrap: nowrap; }
        }

        #info-panel h3 { text-align: center; margin-bottom: 15px; font-size: 1.4em;}
        #info-panel h4 { font-size: 1.1em; color: #87CEFA; margin-top:10px; margin-bottom:5px; }
        /* Removed styles specific to edit fields if any */
        #info-panel button { /* General style for close button */
            background-color: #4A90E2; color: white; padding: 10px 15px; border: none;
            border-radius: 6px; cursor: pointer; margin-top: 15px; transition: background-color 0.3s;
            width: 100%; /* Make close button full width */
        }
        #info-panel button:hover { background-color: #357ABD; }
        
        #close-panel-btn { background-color: #E94E77; } /* Keep close button style */
        #close-panel-btn:hover { background-color: #D33A60; }

        .star-image-preview-container img, #view-star-photo-container img { /* Combined for view */
            max-width: 100%; height: auto; max-height: 100px; object-fit: cover;
            margin-top: 5px; border-radius: 4px; border: 1px solid rgba(100,100,200,0.2);
            display: block; 
        }
        #view-star-photo-container { display: flex; flex-direction: column; gap: 5px; margin-top: 10px;}

        #planet-summary-display { font-size: 0.95em; line-height: 1.5; color: #ddd; margin-top: 5px; }
        /* Removed Gemini related styles */
        .button-container { display: flex; justify-content: center; margin-top: 20px; } /* Center the close button */

        /* Removed #user-info and #admin-controls styles */

        #message-box { position: fixed; bottom: 10px; right: 10px; background-color: rgba(74, 144, 226, 0.9); color: white; padding: 10px 15px; border-radius: 6px; z-index: 100; opacity: 0; transition: opacity 0.5s; font-size: 0.9em; }
        #message-box.visible { opacity: 1; }
        #loading-indicator { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 200; color: white; font-size: 1.5em; }
    
    </style>
</head>
<body>
    <div id="homepage-view" class="view" style="display: flex;">
        <h1>Love You in Lightyears</h1>
        <p>Explore a galaxy of named stars, each a unique tribute. Discover celestial memorials and the stories they hold.</p>
        <div class="contact-info">
            Want to name a star after you or a loved one? <br/>
            Contact me: <a href="#" id="contact-link-placeholder">[_joshii007]</a>
        </div>
        <button id="enter-solar-system-btn">Enter Solar System</button>
        <div id="homepage-credit">Designed by Josh and Gemini AI</div>
    </div>

    <div id="solarsystem-view" class="view">
        <button id="back-to-homepage-btn">Back to Homepage</button> 
        
        <div id="canvas-container"></div>
        <div id="search-bar-container">
            <input type="text" id="coord-search-input" placeholder="X,Y,Z, Star ID or Planet">
            <button id="coord-search-btn">Search</button>
        </div>
        <div id="info-panel">
            <h3 id="panel-title">Object Details</h3>
            <div id="object-id-display-container" style="display:block;">
                <strong>ID:</strong> <span id="object-id-display">N/A</span>
            </div>
            <div id="object-coords-display-container" style="display:block;">
                 <strong>Coords:</strong> <span id="object-coords-display">N/A</span>
            </div>

            <div id="star-view-fields" style="display:none;">
                <h4>Star Information</h4>
                <div><strong>Name:</strong> <span id="view-star-name"></span></div>
                <div><strong>Category:</strong> <span id="view-star-category"></span></div>
                <div id="view-star-photo-container"></div>
                <p id="view-star-description" style="margin-top:10px;"></p>
            </div>

            <div id="planet-info-fields" style="display:none;">
                <h4>Planet Information</h4>
                <div><strong>Name:</strong> <span id="planet-name-display"></span></div>
                <p id="planet-summary-display"></p>
                </div>
            
            <div class="button-container">
                <button id="close-panel-btn">Close</button>
            </div>
        </div>
        </div>

    <div id="loading-indicator" style="display:none;">Loading Solar System...</div>
    <div id="message-box"></div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        // Firebase SDK imports are removed as they are no longer needed for stars/admin

        // ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
        // + EDIT YOUR STAR DATA HERE                                         +
        // + Each object in this array represents a star.                     +
        // + - id: A unique identifier for the star (e.g., 'star_1', 'my_star') +
        // + - name: The name of the star to be displayed.                    +
        // + - category: 'general', 'pet', 'couple', 'milestone', 'other'.    +
        // + - color: The hex color code for the star (e.g., '#FFD700').      +
        // + - photoUrls: An array of image URLs (up to 5). Empty if no photos.+
        // +              e.g., ['https://example.com/image1.jpg']           +
        // + - description: A short message or story about the star.          +
        // + - position: An object with x, y, z coordinates for the star.     +
        // +             Adjust these values to place your stars in the sky.  +
        // ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
        const staticStarData = [
            { id: 'star_1', name: 'The First Light', category: 'milestone', color: '#FFD700', photoUrls: [], description: 'Commemorating a new beginning.', position: { x: 100, y: 200, z: -150 } },
            { id: 'star_2', name: 'Starlight Memories', category: 'general', color: '#A7C7E7', photoUrls: [], description: 'Remembering the good times.', position: { x: -150, y: 100, z: 200 } },
            { id: 'star_3', name: 'Cosmic Love', category: 'couple', color: '#FFB6C1', photoUrls: [], description: 'A tribute to eternal love.', position: { x: 200, y: -50, z: 100 } },
            { id: 'star_4', name: 'Paw Print Nebula', category: 'pet', color: '#98FB98', photoUrls: [], description: 'For a furry friend who crossed the rainbow bridge.', position: { x: -50, y: -150, z: -200 } },
            { id: 'star_5', name: 'Journey\'s Star', category: 'milestone', color: '#E6E6FA', photoUrls: [], description: 'Marking a significant achievement.', position: { x: 300, y: 0, z: 0 } },
            // Add more stars here up to 30 (or more if you wish)
            // Example of a star with photos:
            // { 
            //   id: 'star_6', name: 'Galaxy Guardian', category: 'other', color: '#FF6347', 
            //   photoUrls: ['https://via.placeholder.com/100/FF6347/FFFFFF?Text=StarPic1', 'https://via.placeholder.com/100/FF6347/FFFFFF?Text=StarPic2'], 
            //   description: 'A protector of dreams.', position: { x: 0, y: 300, z: 50 } 
            // },
            // To make it 30 stars, you'll need to add 25 more entries like the ones above,
            // adjusting their names, categories, colors, descriptions, and positions.
            // For unique positions, try varying x, y, and z values between roughly -2000 and 2000.
            // Keep some distance between stars to avoid overlap.
            { id: 'star_6', name: 'Orion\'s Belt Buckle', category: 'other', color: '#FF6347', photoUrls: [], description: 'The flashiest part of the hunter.', position: { x: 0, y: 300, z: 50 } },
            { id: 'star_7', name: 'Sirius B\'s Buddy', category: 'general', color: '#ADD8E6', photoUrls: [], description: 'A companion to the Dog Star.', position: { x: 400, y: 100, z: -100 } },
       { 
                id: 'star_8', 
                name: 'joshii', 
                category: 'milestone', 
                color: '#339cff', 
                photoUrls: ['https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRSekm7vIn208ZOGbLw1GCAWN4vA3JI5ghzqg&s'], 
                description: 'A distant wish, soon to be achieved.', 
                position: { x: -300, y: 250, z: 150 } 
            },  { id: 'star_9', name: 'The Little Dipper\'s Handle', category: 'other', color: '#F0E68C', photoUrls: [], description: 'Guiding light for small scoops.', position: { x: 150, y: -200, z: -50 } },
            { id: 'star_10', name: 'Venus\'s Valentine', category: 'couple', color: '#FFC0CB', photoUrls: [], description: 'Love brighter than the morning star.', position: { x: -250, y: -50, z: 300 } },
            { id: 'star_11', name: 'Comet Tail Sparkle', category: 'general', color: '#B0E0E6', photoUrls: [], description: 'A fleeting moment of brilliance.', position: { x: 500, y: 50, z: -250 } },
            { id: 'star_12', name: 'Jupiter\'s Gem', category: 'milestone', color: '#FFE4B5', photoUrls: [], description: 'A great red achievement.', position: { x: -450, y: 150, z: 0 } },
            { id: 'star_13', name: 'Saturn\'s Ringlet', category: 'other', color: '#D2B48C', photoUrls: [], description: 'A tiny piece of a grand design.', position: { x: 100, y: 400, z: 100 } },
            { id: 'star_14', name: 'Neptune\'s Trident Tip', category: 'general', color: '#4682B4', photoUrls: [], description: 'Piercing the cosmic ocean.', position: { x: -50, y: -300, z: -150 } },
            { id: 'star_15', name: 'Pluto\'s Pal', category: 'pet', color: '#A9A9A9', photoUrls: [], description: 'A distant but cherished friend.', position: { x: 350, y: -100, z: 250 } },
            { id: 'star_16', name: 'Celestial Beacon', category: 'general', color: '#FFFFE0', description: 'Guiding light through the cosmos.', position: { x: 600, y: 200, z: -50 } },
            { id: 'star_17', name: 'Dream Weaver', category: 'milestone', color: '#DDA0DD', description: 'Where aspirations take flight.', position: { x: -550, y: 0, z: 150 } },
            { id: 'star_18', name: 'Eternal Flame', category: 'couple', color: '#FF4500', description: 'A love that burns forever.', position: { x: 250, y: 350, z: 0 } },
            { id: 'star_19', name: 'Silent Watcher', category: 'other', color: '#778899', description: 'Observing the universe unfold.', position: { x: -100, y: -400, z: -100 } },
            { id: 'star_20', name: 'Feline Galaxy', category: 'pet', color: '#FFA07A', description: 'For all the purrs that echo in space.', position: { x: 450, y: -150, z: 200 } },
            { id: 'star_21', name: 'Nova Hope', category: 'milestone', color: '#87CEEB', description: 'A burst of new possibilities.', position: { x: 0, y: 500, z: -200 } },
            { id: 'star_22', name: 'Twin Souls', category: 'couple', color: '#EE82EE', description: 'Two stars, one destiny.', position: { x: -350, y: 300, z: 100 } },
            { id: 'star_23', name: 'Guiding Paw', category: 'pet', color: '#90EE90', description: 'Always leading the way.', position: { x: 200, y: -250, z: -150 } },
            { id: 'star_24', name: 'Achievement Crest', category: 'milestone', color: '#F0E68C', description: 'A pinnacle of success.', position: { x: -400, y: -100, z: 50 } },
            { id: 'star_25', name: 'Mystery Orb', category: 'other', color: '#4B0082', description: 'An enigma wrapped in starlight.', position: { x: 150, y: 450, z: -250 } },
            { id: 'star_26', name: 'Nebula Nook', category: 'general', color: '#BA55D3', description: 'A cozy corner in the cosmos.', position: { x: -200, y: 50, z: 350 } },
            { id: 'star_27', name: 'Stardust Sprinter', category: 'milestone', color: '#00FA9A', description: 'Racing towards a brilliant future.', position: { x: 700, y: 0, z: 0 } },
            { id: 'star_28', name: 'Cosmic Embrace', category: 'couple', color: '#FF69B4', description: 'Held together by gravity and love.', position: { x: -600, y: 200, z: -100 } },
            { id: 'star_29', name: 'Whisker Way', category: 'pet', color: '#FFDAB9', description: 'A trail of happy meows.', position: { x: 300, y: -300, z: 150 } },
            { id: 'star_30', name: 'The Final Frontier Star', category: 'other', color: '#FFFFFF', description: 'Boldly shining where no one has shone before.', position: { x: 0, y: 0, z: 500 } },
        ];
        // ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
        // + END OF STAR DATA EDITING SECTION                                 +
        // ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++


        document.addEventListener('DOMContentLoaded', async () => {
            // --- DOM Element Variables ---
            const homepageView = document.getElementById('homepage-view');
            const solarsystemView = document.getElementById('solarsystem-view');
            const enterSolarSystemBtn = document.getElementById('enter-solar-system-btn');
            const backToHomepageBtn = document.getElementById('back-to-homepage-btn'); 
            const searchBarContainer = document.getElementById('search-bar-container'); 

            const loadingIndicator = document.getElementById('loading-indicator');
            const canvasContainer = document.getElementById('canvas-container');
            const infoPanel = document.getElementById('info-panel');
            const panelTitle = document.getElementById('panel-title');
            const objectIdDisplay = document.getElementById('object-id-display');
            const objectCoordsDisplay = document.getElementById('object-coords-display');
            
            const starViewFields = document.getElementById('star-view-fields');
            const viewStarName = document.getElementById('view-star-name');
            const viewStarCategory = document.getElementById('view-star-category');
            const viewStarPhotoContainer = document.getElementById('view-star-photo-container');
            const viewStarDescription = document.getElementById('view-star-description');
            
            const planetInfoFields = document.getElementById('planet-info-fields');
            const planetNameDisplay = document.getElementById('planet-name-display');
            const planetSummaryDisplay = document.getElementById('planet-summary-display');
                    
            const closePanelBtn = document.getElementById('close-panel-btn');
            const messageBox = document.getElementById('message-box');
            const coordSearchInput = document.getElementById('coord-search-input');
            const coordSearchBtn = document.getElementById('coord-search-btn');

            // --- Three.js Variables ---
            let scene, camera, renderer, controls;
            let sun; 
            const planets = []; 
            const moons = [];
            const stars = []; // This will be populated from staticStarData
            let selectedObject = null;
            const raycaster = new THREE.Raycaster();
            const mouse = new THREE.Vector2(); 
            let shootingStarSystem;
            const SHOOTING_STAR_COUNT = 20;
            
            // --- Planet Data (Remains hardcoded) ---
            const planetSummaries = { 
                "Mercury": "The smallest planet in our solar system and closest to the Sun, Mercury is a world of extreme temperatures. It has a heavily cratered surface, resembling Earth's Moon.",
                "Venus": "Venus is Earth's closest planetary neighbor. Similar in structure and size to Earth, Venus spins slowly in the opposite direction of most planets. Its thick atmosphere traps heat in a runaway greenhouse effect, making it the hottest planet in our solar system.",
                "Earth": "Our home planet, Earth is the only place we know of so far that’s inhabited by living things. It's also the only planet in our solar system with liquid water on the surface.",
                "Mars": "Mars is a dusty, cold, desert world with a very thin atmosphere. There is strong evidence Mars was billions of years ago wetter and warmer, with a thicker atmosphere.",
                "Jupiter": "Jupiter is more than twice as massive than the other planets of our solar system combined. The giant planet's Great Red Spot is a centuries-old storm bigger than Earth.",
                "Saturn": "Adorned with thousands of beautiful ringlets, Saturn is unique among the planets. It is not the only planet to have rings, but none are as spectacular or as complex as Saturn's.",
                "Uranus": "Uranus is the seventh planet from the Sun and has the third-largest diameter in our solar system. It was the first planet found with the aid of a telescope, Uranus is an ice giant.",
                "Neptune": "Dark, cold, and whipped by supersonic winds, ice giant Neptune is the eighth and most distant planet in our solar system. More than 30 times as far from the Sun as Earth, Neptune is the only planet in our solar system not visible to the naked eye."
            };
            
            // --- Event Listeners Setup ---
            enterSolarSystemBtn.addEventListener('click', () => {
                homepageView.style.display = 'none';
                solarsystemView.style.display = 'block';
                loadingIndicator.style.display = 'flex';
                if (!scene) { 
                    initThreeJS(); 
                    animate();
                } else {
                    if(controls) controls.enabled = true; 
                    loadingIndicator.style.display = 'none'; 
                }
            });

            backToHomepageBtn.addEventListener('click', () => {
                solarsystemView.style.display = 'none';
                homepageView.style.display = 'flex';
                infoPanel.classList.remove('visible'); 

                if (controls) {
                    controls.reset(); 
                    controls.enabled = false; 
                }
                selectedObject = null; 
            });
            
            // --- Texture Creation ---
            function createTexture(color, detailColor = null, width = 256, height = 256) {
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const context = canvas.getContext('2d');
                context.fillStyle = color;
                context.fillRect(0, 0, width, height);
                if (detailColor) {
                    for (let i = 0; i < 50 * (width/256); i++) { 
                        context.fillStyle = `rgba(${Math.random()*255}, ${Math.random()*255}, ${Math.random()*255}, ${0.3 + Math.random()*0.4})`;
                        context.beginPath();
                        context.arc(Math.random() * width, Math.random() * height, Math.random() * (width/8), 0, Math.PI * 2);
                        context.fill();
                    }
                }
                return new THREE.CanvasTexture(canvas);
            }
             function createAtmosphereTexture() { 
                const canvas = document.createElement('canvas');
                canvas.width = 128;
                canvas.height = 128;
                const context = canvas.getContext('2d');
                const gradient = context.createRadialGradient(64, 64, 0, 64, 64, 64);
                gradient.addColorStop(0.2, 'rgba(173, 216, 230, 0.8)'); 
                gradient.addColorStop(0.5, 'rgba(70, 130, 180, 0.5)');  
                gradient.addColorStop(1, 'rgba(0, 0, 139, 0)');      
                context.fillStyle = gradient;
                context.fillRect(0, 0, 128, 128);
                return new THREE.CanvasTexture(canvas);
            }

            // --- Three.js Scene Initialization ---
            function initThreeJS() {
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0x000011);
                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 20000);
                camera.position.set(0, 350, 900); 
                renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(window.devicePixelRatio);
                canvasContainer.innerHTML = ''; 
                canvasContainer.appendChild(renderer.domElement);
                
                controls = new OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.minDistance = 10; 
                controls.maxDistance = 10000;
                controls.enabled = true; 
                
                const ambientLight = new THREE.AmbientLight(0xcccccc, 1.0); 
                scene.add(ambientLight);

                const sunBaseColor = '#D95F02'; 
                const sunDetailColor = '#A33B00'; 
                const sunEmissiveColor = 0xBF4800; 
                const sunTexture = createTexture(sunBaseColor, sunDetailColor, 512, 512);
                const sunMaterial = new THREE.MeshBasicMaterial({ map: sunTexture, emissive: sunEmissiveColor, emissiveIntensity: 1.3 });
                sun = new THREE.Mesh(new THREE.SphereGeometry(70, 64, 64), sunMaterial);
                sun.userData = { name: "Sun", id: "sun", isPlanet: true, summary: "The star at the center of our Solar System. It provides the light and heat that make life on Earth possible." };
                scene.add(sun);
                const sunLight = new THREE.PointLight(0xFFDAB9, 3.5, 15000); 
                sun.add(sunLight);

                const planetData = [ 
                     { name: "Mercury", size: 3, color: '#888888', orbitRadius: 120, orbitSpeed: 0.012, moons: [] },
                    { name: "Venus", size: 7, color: '#E6E6FA', orbitRadius: 180, orbitSpeed: 0.009, moons: [] },
                    { name: "Earth", size: 7.5, color: '#4A90E2', orbitRadius: 250, orbitSpeed: 0.007, moons: [
                        { name: "Moon", size: 2, color: '#AAAAAA', orbitRadius: 15, orbitSpeed: 0.05 }
                    ]},
                    { name: "Mars", size: 4.5, color: '#E57373', orbitRadius: 330, orbitSpeed: 0.005, moons: [
                        { name: "Phobos", size: 0.5, color: '#555555', orbitRadius: 8, orbitSpeed: 0.1 }, 
                        { name: "Deimos", size: 0.4, color: '#666666', orbitRadius: 12, orbitSpeed: 0.08 }
                    ]},
                    { name: "Jupiter", size: 30, color: '#D2B48C', orbitRadius: 550, orbitSpeed: 0.002, moons: [
                        { name: "Io", size: 2.5, color: '#FFFF00', orbitRadius: 40, orbitSpeed: 0.06 },
                        { name: "Europa", size: 2.2, color: '#FFF8DC', orbitRadius: 50, orbitSpeed: 0.05 },
                        { name: "Ganymede", size: 3.5, color: '#A9A9A9', orbitRadius: 65, orbitSpeed: 0.04 },
                        { name: "Callisto", size: 3.3, color: '#808080', orbitRadius: 80, orbitSpeed: 0.03 }
                    ]},
                    { name: "Saturn", size: 25, color: '#D4A373', orbitRadius: 750, orbitSpeed: 0.0015, hasRings: true, ringColor: '#BCB091', moons: [
                         { name: "Titan", size: 3.8, color: '#FFA500', orbitRadius: 45, orbitSpeed: 0.035 }
                    ]},
                    { name: "Uranus", size: 15, color: '#AFEEEE', orbitRadius: 950, orbitSpeed: 0.001, moons: [] },
                    { name: "Neptune", size: 14, color: '#3B5998', orbitRadius: 1150, orbitSpeed: 0.0008, moons: [] }
                ];
                let earthRef = null; 
                planetData.forEach(pData => {
                    const planetMaterial = new THREE.MeshStandardMaterial({ color: new THREE.Color(pData.color), roughness: 0.8, metalness: 0.1 });
                    const planet = new THREE.Mesh(new THREE.SphereGeometry(pData.size, 32, 32), planetMaterial);
                    planet.position.x = pData.orbitRadius;
                    planet.userData = { 
                        name: pData.name, 
                        id: pData.name.toLowerCase(),
                        orbitRadius: pData.orbitRadius, 
                        orbitSpeed: pData.orbitSpeed, 
                        orbitAngle: Math.random() * Math.PI * 2, 
                        isPlanet: true,
                        summary: planetSummaries[pData.name] || "No summary available."
                    };
                    sun.add(planet); 
                    planets.push(planet);
                    if (pData.name === "Earth") earthRef = planet;
                    if (pData.hasRings) {
                        const ringMaterial = new THREE.MeshStandardMaterial({ color: new THREE.Color(pData.ringColor), side: THREE.DoubleSide, transparent: true, opacity: 0.6, roughness: 0.9 });
                        const saturnRingsMesh = new THREE.Mesh(new THREE.RingGeometry(pData.size * 1.2, pData.size * 2.2, 64), ringMaterial);
                        saturnRingsMesh.rotation.x = Math.PI / 2.2;
                        planet.add(saturnRingsMesh); 
                    }
                    pData.moons.forEach(mData => {
                        const moonMaterial = new THREE.MeshStandardMaterial({ color: new THREE.Color(mData.color), roughness: 0.9 });
                        const moon = new THREE.Mesh(new THREE.SphereGeometry(mData.size, 16, 16), moonMaterial);
                        moon.position.x = mData.orbitRadius;
                        moon.userData = { 
                            name: mData.name, 
                            id: mData.name.toLowerCase(), 
                            orbitRadius: mData.orbitRadius, 
                            orbitSpeed: mData.orbitSpeed, 
                            orbitAngle: Math.random() * Math.PI * 2, 
                            isMoon: true, 
                            parentPlanet: planet 
                        };
                        planet.add(moon); 
                        moons.push(moon);
                    });
                });
                if (earthRef) { 
                    const atmosphereMaterial = new THREE.SpriteMaterial({
                        map: createAtmosphereTexture(), color: 0x4A90E2, transparent: true, opacity: 0.3, blending: THREE.AdditiveBlending
                    });
                    const atmosphere = new THREE.Sprite(atmosphereMaterial);
                    const earthSize = planetData.find(p=>p.name==="Earth").size;
                    atmosphere.scale.set(earthSize * 2.5, earthSize * 2.5, earthSize * 2.5);
                    earthRef.add(atmosphere);
                }

                createStars(); // Now uses staticStarData
                createShootingStars();
                
                window.addEventListener('resize', onWindowResize, false);
                loadingIndicator.style.display = 'none';
            }
            
            function createStars() {
                stars.length = 0; // Clear existing stars if any (for potential re-init)
                staticStarData.forEach(starData => {
                    const starMaterial = new THREE.MeshBasicMaterial({ color: new THREE.Color(starData.color) });
                    // Star size can be made configurable in staticStarData if desired, e.g., starData.size || 1.5
                    const starGeometry = new THREE.SphereGeometry(starData.size || 1.8, 16, 16); 
                    const star = new THREE.Mesh(starGeometry, starMaterial);
                    
                    star.position.set(starData.position.x, starData.position.y, starData.position.z);
                    
                    star.userData = {
                        id: starData.id,
                        name: starData.name,
                        category: starData.category,
                        color: starData.color, // Store hex color string
                        photoUrls: starData.photoUrls || [],
                        description: starData.description,
                        isStar: true,
                        // Storing originalPosition as a Vector3 locally, though not strictly needed for saving anymore
                        originalPosition: new THREE.Vector3(starData.position.x, starData.position.y, starData.position.z),
                        originalColorHex: new THREE.Color(starData.color).getHexString() // Store hex for consistency
                    };
                    stars.push(star);
                    scene.add(star);
                });
            }
            
            function createShootingStars() { 
                const geometry = new THREE.BufferGeometry();
                const material = new THREE.PointsMaterial({
                    color: 0xffffee, size: 3, transparent: true, opacity: 0.8, blending: THREE.AdditiveBlending, sizeAttenuation: true
                });
                const shootingStarVertices = []; 
                for (let i = 0; i < SHOOTING_STAR_COUNT; i++) {
                    shootingStarVertices.push(
                        (Math.random() - 0.5) * 10000, (Math.random() - 0.5) * 10000, (Math.random() - 0.5) * 10000
                    );
                }
                geometry.setAttribute('position', new THREE.Float32BufferAttribute(shootingStarVertices, 3));
                shootingStarSystem = new THREE.Points(geometry, material);
                shootingStarSystem.userData.velocities = [];
                shootingStarSystem.userData.lifespans = []; 
                for (let i = 0; i < SHOOTING_STAR_COUNT; i++) {
                    resetShootingStar(i);
                }
                scene.add(shootingStarSystem);
            }

            function resetShootingStar(index) { 
                const R = 4000; 
                const phi = Math.random() * Math.PI * 2;
                const theta = Math.random() * Math.PI;
                const x = R * Math.sin(theta) * Math.cos(phi);
                const y = R * Math.sin(theta) * Math.sin(phi);
                const z = R * Math.cos(theta);
                shootingStarSystem.geometry.attributes.position.setXYZ(index, x, y, z);
                const speed = 50 + Math.random() * 50;
                shootingStarSystem.userData.velocities[index] = new THREE.Vector3(
                    -x + (Math.random() - 0.5) * R*0.2, -y + (Math.random() - 0.5) * R*0.2, -z + (Math.random() - 0.5) * R*0.2
                ).normalize().multiplyScalar(speed);
                shootingStarSystem.userData.lifespans[index] = 50 + Math.random() * 100; 
            }

            function updateShootingStars() { 
                if (!shootingStarSystem) return;
                const positions = shootingStarSystem.geometry.attributes.position;
                for (let i = 0; i < SHOOTING_STAR_COUNT; i++) {
                    positions.setXYZ(
                        i,
                        positions.getX(i) + shootingStarSystem.userData.velocities[i].x,
                        positions.getY(i) + shootingStarSystem.userData.velocities[i].y,
                        positions.getZ(i) + shootingStarSystem.userData.velocities[i].z
                    );
                    shootingStarSystem.userData.lifespans[i]--;
                    if (shootingStarSystem.userData.lifespans[i] <= 0) {
                        resetShootingStar(i);
                    }
                }
                positions.needsUpdate = true;
            }

            function onWindowResize() { 
                if (camera && renderer) {
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(window.innerWidth, window.innerHeight);
                }
            }

            // --- Canvas Interaction Handling (Mobile Click Fix) ---
            let pointerDownTime = 0;
            let pointerDownPosition = new THREE.Vector2();

            function handleCanvasTap(event) { 
                const uiElementsToIgnore = [infoPanel, searchBarContainer, backToHomepageBtn];
                for (const uiElement of uiElementsToIgnore) {
                    if (uiElement && uiElement.contains(event.target)) {
                        return; 
                    }
                }
                if (infoPanel.classList.contains('visible') && infoPanel.contains(event.target)) {
                     return;
                }

                if (!scene || !camera) return; 

                mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
                mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
                raycaster.setFromCamera(mouse, camera);

                const allClickableObjects = [...stars, ...planets, sun];
                const intersects = raycaster.intersectObjects(allClickableObjects, true); 

                if (intersects.length > 0) {
                    let rawIntersectedObject = intersects[0].object;
                    selectedObject = rawIntersectedObject; 

                    while (selectedObject.userData && selectedObject.userData.isMoon && selectedObject.parent) {
                        if (planets.includes(selectedObject.parent) || selectedObject.parent === sun) {
                             selectedObject = selectedObject.parent;
                        } else {
                             break;
                        }
                    }
                    
                    const worldPosition = new THREE.Vector3();
                    selectedObject.getWorldPosition(worldPosition); 
                    objectCoordsDisplay.textContent = `X: ${worldPosition.x.toFixed(2)}, Y: ${worldPosition.y.toFixed(2)}, Z: ${worldPosition.z.toFixed(2)}`;

                    starViewFields.style.display = 'none'; // Hide by default
                    planetInfoFields.style.display = 'none'; // Hide by default

                    if (selectedObject.userData.isStar) {
                        panelTitle.textContent = "Star Details";
                        objectIdDisplay.textContent = selectedObject.userData.id;
                        starViewFields.style.display = 'block';
                        populateInfoPanelForStarView(selectedObject);
                    } else if (selectedObject.userData.isPlanet || selectedObject === sun) { 
                        const objectName = selectedObject.userData.name; 
                        panelTitle.textContent = `${objectName} Information`;
                        objectIdDisplay.textContent = selectedObject.userData.id; 
                        planetInfoFields.style.display = 'block';
                        populateInfoPanelForPlanet(selectedObject);
                    }
                    infoPanel.classList.add('visible');
                }
            }
            
            // --- UI Panel Population & Updates ---
             function populateInfoPanelForStarView(star) { 
                // Data now comes directly from star.userData, which was populated from staticStarData
                viewStarName.textContent = star.userData.name;
                const category = star.userData.category;
                let categoryText = category.charAt(0).toUpperCase() + category.slice(1);
                if (category === "pet") categoryText = "Pet Memorial";
                else if (category === "couple") categoryText = "Couple Tribute";
                else if (category === "milestone") categoryText = "Personal Milestone";
                else if (category === "general") categoryText = "General Memorial";
                viewStarCategory.textContent = categoryText;

                viewStarPhotoContainer.innerHTML = ''; 
                const photoUrls = Array.isArray(star.userData.photoUrls) ? star.userData.photoUrls.filter(url => url && url.trim()) : [];

                if (photoUrls.length > 0) {
                    photoUrls.forEach(url => {
                        const img = document.createElement('img');
                        img.src = url;
                        img.alt = "Star photo";
                        img.onerror = () => { img.style.display = 'none'; };
                        viewStarPhotoContainer.appendChild(img);
                    });
                } else {
                     const img = document.createElement('img');
                     img.src = "https://placehold.co/300x200/000022/FFFFFF?text=No+Image"; 
                     img.alt = "No image available";
                     viewStarPhotoContainer.appendChild(img);
                }
                
                viewStarDescription.textContent = star.userData.description || "No description available.";
            }

            function populateInfoPanelForPlanet(planetOrMoon) { 
                const objectName = planetOrMoon.userData.name;
                let summary = planetOrMoon.userData.summary; 

                if (planetOrMoon.userData.isMoon) {
                    summary = `A moon orbiting ${planetOrMoon.userData.parentPlanet.userData.name}. ${summary || 'No specific summary for this moon.'}`;
                     panelTitle.textContent = `${objectName} (Moon) Information`;
                } else { 
                     panelTitle.textContent = `${objectName} Information`;
                }
                
                planetNameDisplay.textContent = objectName;
                planetSummaryDisplay.textContent = summary || "Details for this celestial body are being gathered.";
            }
            
            function searchStarByUserInput() { 
                const input = coordSearchInput.value.trim();
                if (!input) {
                    showMessage("Please enter coordinates, Star ID, or Planet/Moon Name.", true);
                    return;
                }

                let foundTarget = null;
                let targetType = null; 

                // 1. Search static stars by ID or Name (case-insensitive for name)
                foundTarget = stars.find(s => s.userData.id.toLowerCase() === input.toLowerCase() || s.userData.name.toLowerCase().includes(input.toLowerCase()));
                if (foundTarget) targetType = "star";

                if (!foundTarget) {
                    if (sun.userData.name.toLowerCase() === input.toLowerCase()) {
                        foundTarget = sun;
                        targetType = "planet"; 
                    } else {
                        foundTarget = planets.find(p => p.userData.name.toLowerCase() === input.toLowerCase());
                        if (foundTarget) targetType = "planet";
                    }
                }

                if (!foundTarget) {
                    foundTarget = moons.find(m => m.userData.name.toLowerCase() === input.toLowerCase());
                    if (foundTarget) {
                        targetType = "moon"; 
                    }
                }
                
                if (!foundTarget && input.includes(',')) { // Only try coord search if comma is present
                    const parts = input.split(',').map(part => parseFloat(part.trim()));
                    if (parts.length === 3 && !parts.some(isNaN)) {
                        const searchPos = new THREE.Vector3(parts[0], parts[1], parts[2]);
                        let closestStar = null;
                        let minDistanceSq = Infinity;
                        stars.forEach(star => {
                            const starPos = new THREE.Vector3();
                            star.getWorldPosition(starPos); 
                            const distanceSq = starPos.distanceToSquared(searchPos);
                            if (distanceSq < minDistanceSq) {
                                minDistanceSq = distanceSq;
                                closestStar = star;
                            }
                        });
                        if (closestStar && minDistanceSq < (500*500) ) { 
                            foundTarget = closestStar;
                            targetType = "star";
                        }
                    }
                }

                if (foundTarget) {
                    let displayObject = foundTarget; 
                    if (targetType === "moon" && foundTarget.userData.parentPlanet) {
                        displayObject = foundTarget.userData.parentPlanet; 
                    }
                    
                    const focusTargetPosition = new THREE.Vector3();
                    foundTarget.getWorldPosition(focusTargetPosition); 
                    
                    controls.target.copy(focusTargetPosition); 

                    let offsetDistance;
                    const targetRadius = foundTarget.geometry.parameters.radius || (targetType === "star" ? 1.8 : 10); // Use default from creation
                    if (targetType === "star") {
                        offsetDistance = targetRadius * 15 + 70; 
                    } else { 
                        offsetDistance = targetRadius * 5 + 100; 
                    }

                    let direction = new THREE.Vector3().subVectors(camera.position, focusTargetPosition);
                    if (direction.lengthSq() < 0.0001) { 
                        direction.set(0, 0.5, 1); 
                    }
                    direction.normalize();
                    
                    const newCameraPosition = new THREE.Vector3().addVectors(focusTargetPosition, direction.multiplyScalar(offsetDistance));
                    camera.position.copy(newCameraPosition);
                    controls.update(); 

                    starViewFields.style.display = 'none';
                    planetInfoFields.style.display = 'none';
                    
                    const displayObjWorldPos = new THREE.Vector3();
                    displayObject.getWorldPosition(displayObjWorldPos); 
                    objectCoordsDisplay.textContent = `X: ${displayObjWorldPos.x.toFixed(2)}, Y: ${displayObjWorldPos.y.toFixed(2)}, Z: ${displayObjWorldPos.z.toFixed(2)}`;

                    selectedObject = displayObject; 

                    if (displayObject.userData.isStar) {
                        panelTitle.textContent = "Star Details";
                        objectIdDisplay.textContent = displayObject.userData.id;
                        starViewFields.style.display = 'block';
                        populateInfoPanelForStarView(displayObject);
                        
                    } else if (displayObject.userData.isPlanet || displayObject === sun) { 
                        const objectName = displayObject.userData.name;
                        panelTitle.textContent = `${objectName} Information`;
                        objectIdDisplay.textContent = displayObject.userData.id;
                        planetInfoFields.style.display = 'block';
                        populateInfoPanelForPlanet(displayObject);
                    }
                    
                    infoPanel.classList.add('visible');
                    showMessage(`Focusing on: ${foundTarget.userData.name || foundTarget.userData.id}`);
                } else {
                    showMessage("Object not found with the given ID, name, or coordinates.", true);
                }
            }

            function showMessage(message, isError = false) { 
                messageBox.textContent = message;
                messageBox.style.backgroundColor = isError ? 'rgba(200, 50, 50, 0.9)' : 'rgba(74, 144, 226, 0.9)';
                messageBox.classList.add('visible');
                setTimeout(() => { messageBox.classList.remove('visible'); }, 3000);
            }
            
            function animate() { 
                requestAnimationFrame(animate);
                if (controls && controls.enabled) controls.update(); 

                const time = Date.now() * 0.0001; // Base time factor

                // Adjust the '20' multiplier lower to slow down orbits further, or higher to speed them up.
                const orbitalSpeedMultiplier = 40; 

                planets.forEach(planet => {
                    // The 'planet.userData.orbitAngle' on the right side is the initial random angle set during setup.
                    // The 'planet.userData.orbitAngle' on the left side is where the new total angle for the current frame is stored.
                    // This formula calculates the absolute orbital angle based on elapsed time and the initial offset.
                    const calculatedPlanetAngle = (planet.userData.orbitAngle || 0) + time * (planet.userData.orbitSpeed * orbitalSpeedMultiplier);
                    
                    planet.position.x = Math.cos(calculatedPlanetAngle) * planet.userData.orbitRadius;
                    planet.position.z = Math.sin(calculatedPlanetAngle) * planet.userData.orbitRadius;
                    planet.rotation.y += 0.002; // Self-rotation speed (per frame)
                });

                moons.forEach(moon => {
                    const calculatedMoonAngle = (moon.userData.orbitAngle || 0) + time * (moon.userData.orbitSpeed * orbitalSpeedMultiplier);

                    moon.position.x = Math.cos(calculatedMoonAngle) * moon.userData.orbitRadius;
                    moon.position.z = Math.sin(calculatedMoonAngle) * moon.userData.orbitRadius;
                    moon.rotation.y += 0.005; // Self-rotation speed (per frame)
                });

                updateShootingStars();
                if (renderer && scene && camera) renderer.render(scene, camera);
            }

            // Canvas interaction listeners
            canvasContainer.addEventListener('pointerdown', (event) => {
                if (event.isPrimary === false) return; 
                pointerDownTime = Date.now();
                pointerDownPosition.set(event.clientX, event.clientY);
            }, false);

            canvasContainer.addEventListener('pointerup', (event) => {
                if (event.isPrimary === false) return; 

                const timeThreshold = 250; 
                const positionThreshold = 10; 

                const upTime = Date.now();
                const pressDuration = upTime - pointerDownTime;
                const moveDistance = pointerDownPosition.distanceTo(new THREE.Vector2(event.clientX, event.clientY));

                if (pressDuration < timeThreshold && moveDistance < positionThreshold) {
                    handleCanvasTap(event); 
                }
            }, false);

            // Other general event listeners
            closePanelBtn.addEventListener('click', () => infoPanel.classList.remove('visible'));
            coordSearchBtn.addEventListener('click', searchStarByUserInput);

        }); // End of DOMContentLoaded listener
    </script>
</body>
</html>
